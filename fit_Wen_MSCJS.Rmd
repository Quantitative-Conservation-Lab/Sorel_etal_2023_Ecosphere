---
title: Survival and age at maturation of juvenile spring Chinook emigrants from Chiwawa,
  Nason and White River
author: "Mark Sorel"
date: "12/17/2020"
output:
  pdf_document: default
  html_document: default
---



## Introduction


In this chapter, I will characterize how Chinook salmon survival and age at return vary through time due to stochasticity, environmental drivers, and individual heterogeneity (i.e., the timing of emigration from natal streams). Characterizing variability in vital rates is key to ultimately evaluating extinction risk, which can inform how management actions such as hatchery supplementation, habitat restoration, and hydroelectric dam operations can be deployed to prevent extinction. Characterizing how the timing of juvenile emigrants affects their subsequent survival and age at maturity will enable more mechanistic predictions of the effect of different habitat restoration treatments on population dynamics. I will also evaluate how survival is related to environmental variables like river temperature and sea surface temperature, to enable simulation of the effects of climate warming on survival, in future analyses. 


## Methods

### Study system

- Spring Chinook
  - Juvenile behavior from emigration from natal stream to smolting
  - Downstream migration
  - Ocean
  - Upstream
- Wenatchee / Columbia Rivers
  - Hydrograph/ thermal regime
  - Hydrosystem
    - Fish passage
      -Downstream / upstream
- Marine  
  
We studied a population of spring run Chinook salmon that spawns in the Wenatchee River basin as a case study for model development and to learn about how vital rates vary among among streams and juvenile life histories, as well as their associations with environmental covariates. The Wenatchee River is a tributary of the upper Columbia River (RKm 754) located in north-central Washington State, with a drainage area of roughly 3,437 km2 (Figure 1).The population of spring Chinook salmon in the Wenatchee River has been intensively monitored since the mid 1990's due to its endangered status under the ESA and to evaluate the efficacy of a conservation hatchery program that serves as mitigation for impacts on fish of hydroelectric dams on the main stem of the Columbia River. 

The population is considered a spring run due to the early return timing of adults from the ocean. This early return timing, before adults have fully matured, is an adaptation to allow for increased access to high elevation spawning habitat prior to the onset of low flows and high temperatures during the summer, however, adults don't spawn until early fall. Juveniles emerge from the gravel in late winter and in the Columbia River basin tend to exhibit a stream-type life history, wherein they rear in freshwater extensively prior to migrating to the marine environment (smolting). The most common juvenile life history for spring Chinook salmon populations in the Columbia River Basin is to smolt in their second spring, just over a year following emergence. Wenatchee River spring Chinook express this juvenile life history with remarkable consistency, whereas other species of anadromous salmonids and other populations of Chinook exhibit more life history diversity in terms of age at smolting. 

Spring Chinook salmon do exhibit considerable life history diversity with regards to dispersal from natal sites for freshwater rearing, however. Spawning tends to occur in the upper reaches or watersheds and some juveniles disperse to use downstream rearing habitats, while others remain in natal areas until smolting. This diversity in juvenile freshwater habitat use may increase population stabality and increase the capacity of freshwater habitat to support juveniles rearing, however, it complicates monitoring because juveniles are often enumerated when emigrating from their natal reach. Juvenile emigrating from natal reaches at different times of year have different survival rates to adulthood and use different habitats, so understanding their survival following emigration is paramount to understanding the contribution of different juvenile life history strategies to population productivity.  

Regardless of their dispersal behavior and rearing habitat within freshwater, nearly all juveniles smolt during their second spring. When migrating to the ocean, juvenile salmon and steelhead from the Wenatchee River must pass three hydroelectic Dams on the upper Columbia River above the confluence with the Snake River: Rock Island Dam (rkm 729), Wanapum Dam (rkm 668), and Priest Rapids Dam (rkm 639) (Figure 1). They pass an additional four dams on the main stem of the Columbia River downstream of the confluence with the Snake River: McNary Dam (rkm 470), John Day Dam (rkm 347), The Dalles Dam (rkm 307), and Bonneville Dam (rkm 234). All seven dams are equipped with systems to divert fish away for turbines and into pathways designed to pass juvenile fish downstream. In addition, water is spilled over top of dams so that fish may pass dams via the spillways. The hydrograph of the Columbia River is regulated by the storage and release of water from manmade reservoirs in it's upper reaches and tributaries. While this regulation has reduced the magnitude of the spring freshet, water is released from storage reservoirs during the spring smolt migration and water is spilled over dams in the migration corridor to aid fish migration and dam passage. 

Once fish enter the marine environment, Columbia River spring Chinook generally swim northward to the productive marine waters in the Gulf of Alaska, and reside off the continental shelf for one to three years before returning to the Columbia River in spring. The majority of adults spend two years at sea, and most fish that spend only one year at sea are males (known as Jacks). Upstream migrating salmon pass dams via fish ladders that provide flowing water at an appropriate gradiant and with holding pools such that fish are attracted to and able to navigate upstream through them. In addition to the dams on the Columbia River, fish must pass Tumwater Dam on the main stem of the Wenatchee River (RkM ___) (Figure 1). This dam is no longer used for power generation and is equipped with adult fish passage facilties. 


### Data
- Map
- Juvenile tagging
  - Capture
  - Taging
  - Timing
  
- Detection
  - Juvenile bypasses 
    - Length effects
  - Adult fish ladders
  
Upon emigration from three natal stream - the Chiwawa River, Nason Creek, and the White River - juvenile spring Chinook salmon were sampled with rotary screw traps (*cite*) (Figure 1). The traps were installed in early spring and operated continuously through late fall. From 2006 through 2016, juveniles > 60 mm were implanted with passive integrated transponder (PIT) tags within their peritoneal cavity using a syringe. *Add information on tag loss and tagging mortality*. Each PIT tag had a unique radio-frequency identification (RFID) code that transmitted when triggered by an electromagnetic interrogation pulse from an RFID reader device. 

Fish-passageways for both juveniles and adults at certain dams were equipped with RFID reader devices, and the ID codes and timing of fish using these passageways were recorded. We used the detection histories of individuals passing dams to learn about their survival and maturation age probabilities. Specifically, we used detections of juveniles at McNary and Bonneville Dams, and defections of Adults at Bonneville, McNary, Priest Rapids, Rock Island, and Tumwater Dams. Only juveniles which passed via the turbine-bypass pathways had the change of to be detected, as there were no RFID readers in the spillways or the turbine penstocks. The dates and locations that marked fish were released and subsequent detected at dams were downloaded from the Columbia Basin PIT Tag Information System (data citation).  


```{r, cache=FALSE, echo=FALSE, warning=FALSE, message=FALSE}
options(tinytex.verbose = TRUE)
knitr::opts_chunk$set(echo=FALSE, cache = FALSE)
library(here)
library(tidyverse)
library(TMB)
library(TMBhelper)
library(glmmTMB)
library(RMark)
```

Table. Detections by site and year.
Note: Fish released at Lower Wenatchee are not included in this table.

```{r, eval=TRUE, echo=FALSE, message=FALSE, warning=FALSE, cache=TRUE, paged.print=TRUE}
source(here("src","mscjs_wen_helper_funcs.R"))
source(here("src","Wen_MSCJS_re.R"))

# mark_file_CH$rel_DOY_2<-mark_file_CH$`Release Day Number`+ifelse(mark_file_CH$LH=="smolt",365,0)
# hist(mark_file_CH$rel_DOY_2,breaks=seq(0,600,10))
# hist(mark_file_CH$`Length mm`,breaks=seq(0,max(mark_file_CH$`Length mm`,na.rm=TRUE)+5,2.5))
# cor(mark_file_CH$`Length mm`,mark_file_CH$rel_DOY_2,use="complete.obs")


site_year_det<-mark_file_CH %>% filter(LH!="Unk") %>%  select(sea_Year_p,LWe_J:Tum_A) %>%  group_by(sea_Year_p) %>% summarise_all(function(x)sum((x>0))) #%>% print(n=100)
#not using TDD_A or JDD_A currently because of missing years and relatively good detection upstream.
knitr::kable(site_year_det %>%  select(sea_Year_p,LWe_J,McN_J,Bon_J,Bon_A,McN_A,Tum_A) %>% rename(release_year=sea_Year_p) %>% filter(release_year<=2020))
```


The first year (2003) is followed by a three year "gap", so I will start the analysis with the 2006 downstream migration year.

For whatever reason, when I include John Day Dam juvenile or the estuary towed array in the model, it survival of 100% between McNary and John Day and between Bonneville and the Towed Array. I'm  excluding John Day and the estuary towed array  for now and just modeling survival from McN_J to Bon_J. For adults, I'm including Bonneville, McNary and Tumwater only for now, because detection rates and survival rates are high for adults. 


### Model
We used a multistate Cormack-Jolly-Seber model to estimate survival and maturation age probabilities (*check term used for consistency throughout*), where the states corresponded with the number of years spent at sea. Therefore, for all intervals other than that between when juveniles passed downstream of Bonneville Dam and when they passed upstream of Bonneville Dam as adults, the only possible state transition was between their current state and the dead state. Only during the ocean-residence period could fish transition between multiple states, returning as 3, 4, or 5 year-olds. However, once smolts passed downstream of Bonneville Dam, they could not have been detected again until they returned to the Columbia River and passed upstream of Bonneville Dam, so probabilities of marine-survival were confounded with probabilities of returning at alternative ages and only the joint probabilities of survival and return age were identifiable (Buchanan and Skalski 2007).  

We considered 4 group covariates over which vital rates and detection probabilities might vary: juvenile life history strategy, natal stream, and year. The first time period in the model was between juvenile emigration from their natal stream and when they passed McNary Dam en route to the ocean. However, the length of time that this period represented varied from nearly a year for the earliest emigrating juveniles to weeks for fish that reared entirely within the natal stream. To account for the heterogeneity in survival rates that this range of elapsed times would cause, we divided fish into three juvenile life-history groups, that corresponded with modes of emigration timing from the natal stream delineated in previous work (Chapter 1). The earliest emigrating juveniles from the natal stream (hereafter summer emigrants), emigrated as subyearlings between day of year 141 and 262. The subsequent group of emigrants (hereafter fall emigrants), emigrated as subyearlings from day of year 263 through when the traps were removed in early winter. The final group of emigrants (hereafter "smolts"), emigrated as yearlings in spring (day of year 53-179), and were delineated from subyearlings based on a previously developed length-date cutoff rule (chapter 1). We also considered whether fish in these different groups had different survival, maturation age, and detection probabilities at subsequent life stages, as could result from variation in vitality or growth rates of fish that expressed different juvenile life histories. We also considered whether vital rates and detection probabilities could vary among fish from different natal streams, among years, and for different aged adults during their upstream migration.    

Table. releases and detections at different sites by life history (LH), stream, and site.

```{r data_examine, echo=FALSE, message=FALSE, warning=FALSE, paged.print=TRUE}
sample_sizes<-select(mark_file_CH,sea_Year_p,LH,stream,LWe_J,McN_J,Bon_J,Bon_A,McN_A,Tum_A) %>% filter() %>% group_by(LH,stream) %>% summarise_all(function(x)sum((x>0)))%>% rename(released=sea_Year_p)#%>% print(n=100)
#no adult detections of white summer and few for white fall and smolt
# select(mark_file_CH,sea_Year_p,LH,stream,LWe_J:Tum_A) %>% group_by(LH,stream,sea_Year_p) %>% summarise_all(function(x)sum((x>0)))%>% rename(released=sea_Year_p)%>% print(n=100)
knitr::kable(sample_sizes) 
```

Numbers's of detections quite low for some stream x life history combinations, especially adults. 0 adult detections of White river summer emigrants. 


A multistate Cormack-Jolly-Seber model is a class of Hidden Markov Model and therefore the likelihood of a given capture history $x$ at occasions 1 through T can be calculated using the forward algorithm,

$$\mathcal{L}\left(\theta\mid x_1,\ldots,x_T\right)=\delta P\left(x_1\right)\Gamma P\left(x_2\right)\cdots\Gamma P\left(x_{T-1}\right)\Gamma P\left(x_T\right)1$$

where $\theta$ is a vector of probabilities of survival ${\phi}_{t,l,a,y,s}$ , maturation $\psi_{l,a,y,s}$, and detection ${p}_{t,l,a,y,s}$. In the likelihood, $\delta$ is the initial distribution vector of state probabilities at release, ${P}$ are state-dependent distributions that are diagonal matrices of conditional probabilities of observations given a fish is in each state, $\Gamma$ are state transition probability matrices specifying the probability of transitioning from each state at time t to each state at time t + 1, and $\mathbf{1}$ is a column vector of ones (See Zucchini et al. 2016 or McClintock et al. 2020 for details on the forward algorithm for hidden Markov models). 

The initial probability vector represents a probability of 1.0 that fish are alive at release.

Transition matrix for all intervals other than the marine-residence interval.  

$$\begin{array}{rccc}&  Alive   & Dead \\Alive & \phi_{t,l,a,y,s} &  1-\phi_{t,l,a,y,s} \\Dead & 0 &1 \\ \end{array}$$



Transition matrix for the marine-residence interval.   

$$\begin{array}{rccccc}
& 3~year~old & 4~year~old  & 5~year~old & dead \\
Alive &  \phi_{l,a,y}(\psi_{l,a,y,1}) & \phi_{l,a,y}(\psi_{l,a,y,2}) & \phi_{l,a,y}(\psi_{l,a,y,3}) & 1-\phi_{i,t,y} \\
Dead & 0 & 0 &  0 & 1 \\ 
\end{array}$$



Observation matrix

 $$\begin{array}{rccc}&  Detected   & Not~ detected \\Alive &  p_{t,l,a,y,s} &  1-p_{t,l,a,y,s} \\Dead & 0 &1 \\\end{array}$$


The detection rate of adults passing Tumwater Dam was fixed at 1 for parameter identifiability and because the proportion of PIT-tagged adults detected upstream of Tumwater Dam that were also detected at Tumwater Dam approaches 1 (supplement). 
 

Survival and detection probabilities were modeled using a logit link.

The joint probability of marine survival and age at maturation was modeled as follows. The marginal probability of survival across all return ages corresponding with a given year of marine entry was modeled with a logit link. The conditional probabilities of returning at ages 3, 4, or 5 given a fish survived was modeled using a multinomial logit link. This formulation was chosen because it is believed that much of the variability in smolt-to-adult survival is determined within the first year or even the first weeks of marine residence and therefore affects the total number of returning adults of all ages. Our formulation allowed us to model interannual variability in the marginal survival probability of adults returning at all ages. The conditional probabilities of survivors returning at different ages therefore represented variability in survival rates after the first year and in the probabilities that fish of different ages residing within the ocean returned to the Columbia River.




Look at the distributions of tagged fish's lengths vs lengths of fish captured in the screw trap.  Grey is fish captured in the screw trap and red is tagged.  

```{r message=FALSE, warning=FALSE, examine_tag_distribution,eval=TRUE}
ggplot(all_bio_data,aes(x=Length))+geom_density(alpha=.5,fill="black",color=NA)+facet_wrap(~LH,scales = "free_y",nrow = 2)+geom_density(data=mark_file_CH %>% filter(LH!="Unk"),aes(x= `Length.mm`), alpha=.5,fill="red",color=NA)+xlim(30,130)

# ggplot(all_bio_data,aes(x=DOY))+geom_density(alpha=.5,fill="black",color=NA)+facet_wrap(~LH,scales = "free_y")+geom_density(data=mark_file_CH,aes(x=`Release.Day.Number`), alpha=.5,fill="red",color=NA)

```

Takeaway: there is definitely a bias toward larger fish during summer being tagged (because their is a size cutoff for how small of a fish can be tagged - 60 mm). We can address this by including release length  as a covariate and use that relationship to account for the expected survivals of the untagged component of the population. I wonder if that is better left out of this paper and included in the population model paper though.




```{r, message=FALSE, warning=FALSE, process_dat,echo=FALSE}
mscjs_dat<- make_dat(mark_file_CH ,sites=c( "LWe_J",
  "McN_J",
  #"JDD_J",
   "Bon_J",
   #"Est_J",
  "Bon_A","McN_A",
  #"PRa_A","RIs_A",
  "Tum_A"),cont_cov=c(),length_bin = 5,doy_bin = 10,start_year = 2006, end_year = 2017)#,"rel_DOY_bin","length_bin"

rm(mark_file)
rm(all_bio_data)
rm(mark_file_CH)
# gc()
# head(mscjs_dat$p.design.dat)
# 
# dim(mscjs_dat$Phi.design.dat)
# range(mscjs_dat$Phi.pim_unk)
# dim(mscjs_dat$dat_out)
# mscjs_dat$n_known_CH
# mscjs_dat$n_unique_CH
# mscjs_dat$Phi_pim[[1]]
# range(mscjs_dat$p_pim_sim)
# mscjs_dat$n_unk_LH_p
# mscjs_dat$n_known_LH_p
# mscjs_dat$p.pim_unk
# head(mscjs_dat$)

```

## print out of model parameters  
Everything modeled on logit scale, but see plots below for estimates of annual survival and maturation age probabilities

**Phi = survival**  
time 1 = release to lower Wenatchee trap  
time2 = lower wenatchee to McNary  
time 3 = McNary to Bonneville  
time4 = smolt to adult Bonneville to Bonneville  
time5 = upstream Bonneville to McNary  
time6 = upstream McNary to Tumwater  
Win_air = winter air temperature  
sum_flow = summer discharge  
RIS_temp = spring upper Columbia temp  
ersstWAcoast.sum = summer sea surface temperature off washington coast  

**p = detection probability**  
time2 = Lower Wenatchee trap  
time3 = McNary Juvenile  
time4 = Bonneville Juvenile  
time5 = Bonneville Adult  
time6 = McNary Adult  
Tumwater adult detection assumed 100%  
LWe_J = detection in lower wenatchee trap (used to model individual heterogeneity, some fish more or less likely to be detected in general)  
McN_J = detected at McNary Juvenile (see above)  

**Psi = maturation age probability**  
tostratum2 = return as Jack (one year at sea)  
tostratum3 = return as 5-yo (three years at sea)  
I know those names are confusing.  

```{r echo=FALSE, message=FALSE, warning=FALSE}

#experimental
# gc()
# colnames(mscjs_dat$Phi.design.dat)
mscjs_fit<-fit_wen_mscjs(x=mscjs_dat,
                         phi_formula=par.index~
                           
                           #fixed effect
                           -1+ time1:LH +#time1:LHsummer:streamChiwawa + time1:LHsmolt:streamNason+
time1:streamWhite:LH+# time1:LHsmolt:spr_air+
                         +time1:sum_flow:LHsummer+time1:win_air:age_0 + #time1:LHsmolt+#+time1:LHsummer+ time1:streamWhite+ time1:streamNason+# time1:LWe_new+ 
                           time2 +  time2:LHsmolt  + #time2:RIS_temp_juv +  #time2:streamNason+ #to mcnary
                           time3 +#time3:McN_flow +#to Bonneville
                           time4 + time4:LHsmolt + time4:LHsummer+ 
                           time4:ersstWAcoast.sum + #to Bonn adult
                           time5 +#to McNary
                           time6 +#time6:stratum3 +    #to Tumwater
                           #random
                           diag(0+time2+time4 |mig_year)#+
                            # diag(0+time1:LHsmolt|mig_year)
                         ,
                      
                         p_formula= par.index~
                           #fixed effects
                           -1+ time2:age_class+#time2:LHsmolt+time2:LHsummer+time2:streamWhite+#lower trap
                            time3+  #McNary
                             # time3:LWe_J +               #McNary
                            time4+#Bonneville
                           time4:McN_J:age_0 +   #Bonneville
                           time5 +         # Bonn adult
                           time6 +#:stratum +         #McNary adult
                           #random
                           (0+time2|mig_year) +
                           # diag(0+time2:age_0|mig_year) + # lower trap
                           (0+time3+time4|mig_year)+# McNary
                           diag(0+time5|mig_year) #Bonneville
                             # (0+time6|mig_year)
                           
                           ,
                         
                         psi_formula= par.index~
                           #fixed effects
                           -1+tostratum+tostratum:LHsmolt+tostratum3:streamChiwawa+
                           #random
                             (0+tostratum|mig_year)
                         ,
                         
                         doFit = TRUE,silent=TRUE,
                         sim_rand =1,REML=FALSE,hypersd=3
)


#test
#experimental
# gc()
# colnames(mscjs_dat$Phi.design.dat)
mscjs_fit<-fit_wen_mscjs(x=mscjs_dat,
                         phi_formula=par.index~
                           
                           #fixed effect
                           -1+ time1:LH + #time1:LHsummer:streamChiwawa + time1:LHsmolt:streamNason+
time1:streamWhite:LHsmolt+time1:streamWhite:LHfall+ 
                         +time1:sum_flow:LHsummer+time1:win_air:age_0 + 
                           time2 +  time2:LHsmolt  +#time2:RIS_temp_juv +  #time2:streamNason+ #to mcnary
                           time3 + #time3:McN_flow +#to Bonneville
                           time4 + time4:LHsmolt + time4:LHsummer+ 
                           time4:ersstWAcoast.sum + #to Bonn adult
                           time5 +#to McNary
                           time6 +#time6:stratum3 +    #to Tumwater
                           #random
                           diag(0+time1+time2 |mig_year)+
                          (0+time4 |mig_year)#+
                            # diag(0+time1:LHsmolt|mig_year)
                         ,
                      
                         p_formula= par.index~
                           #fixed effects
                           -1+ time2:LH+#time2:LHsmolt:length_bin#time2:LHsmolt+time2:LHsummer+time2:streamWhite+#lower trap
                            time3+  #McNary
                            # time3:LWe_J:LHfall +               #McNary
                            time4+#Bonneville
                           time4:McN_J:age_0 +  #Bonneville
                           time5 +         # Bonn adult
                           time6 +#:stratum +         #McNary adult
                           #random
                           (0+time2|mig_year) +
                           diag(0+time2:LHfall+time2:LHsummer|mig_year) + # lower trap
                           (0+time3+time4|mig_year)+# McNary
                           (0+time5|mig_year) #Bonneville
                             # (0+time6|mig_year)
                           
                           ,
                         
                         psi_formula= par.index~
                           #fixed effects
                           -1+tostratum+tostratum:LHsmolt+tostratum3:streamChiwawa+
                           #random
                             (0+tostratum|mig_year)
                         ,
                         
                         doFit = TRUE,silent=TRUE,
                         sim_rand =0,REML=FALSE
)

print_out(mscjs_fit)
dev.new()
plot_func()
```

Estimated annual proportions of fish tagged in lower Wenatchee trap that were yearling emigrants from natal streams  

```{r, echo=FALSE}
test<-mscjs_fit$mod$report()
test$p_yrlngs %>% `names<-`(c(2006:2010,2013:2017)) %>% round(2)

```


## Figures. Survival and maturation age probs

```{r plot_output, echo=FALSE, fig.width=8,fig.height=7}
plot_func<-function(){
sd_rep<-mscjs_fit$fit$SD
mod_rep<-mscjs_fit$mod$report()

Phi.design.dat2 <- mscjs_dat$Phi.design.dat%>% mutate(phi_fit=mod_rep$phi[1:mscjs_dat$n_known_LH_phi],
                                            eta_phi= sd_rep$value[names(sd_rep$value)=="eta_phi"],
                                            eta_phi_sd=sd_rep$sd[names(sd_rep$value)=="eta_phi"],
                                            lcl_phi=plogis(qnorm(.025,eta_phi,eta_phi_sd)),
                                            ucl_phi=plogis(qnorm(.975,eta_phi,eta_phi_sd))) %>% 
  mutate(LH=fct_relevel(LH,"summer","fall","smolt"))

# Phi.design.dat2<-Phi.design.dat2 %>% select(time ,stratum , LH , stream ,mig_year, phi_fit)

p.design.dat <- mscjs_dat$p.design.dat %>% mutate(p_fit=mod_rep$p[1:mscjs_dat$n_known_LH_p],
                                            eta_p=sd_rep$value[names(sd_rep$value)=="eta_p"],
                                            eta_p_sd=sd_rep$sd[names(sd_rep$value)=="eta_p"],
                                            lcl_p=plogis(qnorm(.025,eta_p,eta_p_sd)),
                                            ucl_p=plogis(qnorm(.975,eta_p,eta_p_sd)))


Psi.design.dat<-mscjs_dat$Psi.design.dat %>% filter(tostratum==2) %>% select(LH,mig_year,stream,McN_J) %>% cbind(mod_rep$psi) %>% filter(LH!="summer",McN_J==0,stream!="LWE") %>% pivot_longer(`1`:`3`,names_to="years",values_to="prop") %>% mutate(LH=ifelse(LH=="fall","Subyearling","Smolt")) %>% distinct()

  
#downstream  survival
 # dev.new()
ggplot(data= as_tibble(Phi.design.dat2) %>% filter(Time<=2),aes(x=(mig_year) ,y=phi_fit,color=stream)) +scale_x_discrete(guide = guide_axis(check.overlap = TRUE))+geom_linerange(aes(ymin=lcl_phi,ymax=ucl_phi),position=position_dodge(width = .75))+facet_grid(rows=vars(time),cols=vars(LH),labeller =  labeller(time=c(`1`="Release to Lower Wenatchee",`2`="Lower Wenatchee to McNary", `3` = "McNary to Bonneville ")),scales = "free")+ylim(0,1)+xlab("Smolt year")+ylab("Survival") + geom_point(position=position_dodge(width = .75))
}
```

\newpage

```{r plot_output2, echo=FALSE, fig.width=8,fig.height=7}
#ocean
ggplot(data= as_tibble(Phi.design.dat2) %>% filter(Time==3),aes(x=(mig_year) ,y=phi_fit,color=stream)) + geom_point(position=position_dodge(width = .75))+geom_linerange(aes(ymin=lcl_phi,ymax=ucl_phi),position=position_dodge(width = .75))+facet_grid(rows=vars(time),cols=vars(LH),labeller =  labeller(time=c(`4`="Bonneville to Bonneville (adult)")),scales = "free") + xlab("Smolt year")+ylab("Survival")+ geom_point(position=position_dodge(width = .75))+scale_x_discrete(guide = guide_axis(check.overlap = TRUE))

# return age proportions
# dev.new()
ggplot(data= as_tibble(Psi.design.dat), aes(fill=years ,x = mig_year, y =prop)) + geom_bar(stat="identity", width=1)+labs(color = "Sea years") + ylab("Proportion")+xlab("Smolt year") +facet_grid(stream~ LH)+ scale_x_discrete(guide = guide_axis(check.overlap = TRUE))

#upstream survival
# dev.new()
ggplot(data= as_tibble(Phi.design.dat2) %>% filter(Time>3),aes(x=(mig_year) ,y=phi_fit,color=stratum)) + geom_point(position=position_dodge(width = .75))+labs(color = "Sea years")+geom_linerange(aes(ymin=lcl_phi,ymax=ucl_phi),position=position_dodge(width = .75)) + facet_grid(rows=vars(time),cols=vars(LH),labeller =  labeller(time=c(`5`="Bonneville to McNary",`6`="McNary to Tumwater ")),scales = "free")+ylim(0,1)+xlab("Return year")+ylab("Survival")+ geom_point(position=position_dodge(width = .75)) + scale_x_discrete(guide = guide_axis(check.overlap = TRUE))

```

## Figures. Detection probabilties    
  
```{r detection_prob_figs, echo=FALSE, fig.width=8,fig.height=7}
#detection probability
#time 2 (LH x stream x year)
# dev.new()
ggplot(data= as_tibble(p.design.dat) %>% filter(Time==0),aes(x=mig_year ,y=p_fit,color=LH)) + geom_point(position=position_dodge(width = .5))+geom_linerange(aes(ymin=lcl_p,ymax=ucl_p),position=position_dodge(width = .5))+facet_grid(time~stream,scales="free",labeller =  labeller(time=c(`2`="Lower Wenatchee",`3`="McNary")))+xlab("Smolt year")+ylab("Detection")+ geom_point(position=position_dodge(width = .75)) + scale_x_discrete(guide = guide_axis(check.overlap = TRUE))
```
\newpage
```{r detection_prob_figs2, echo=FALSE, fig.width=8,fig.height=7}

ggplot(data= as_tibble(p.design.dat) %>% filter(Time==1),aes(x=mig_year ,y=p_fit,color=LH)) + geom_point(position=position_dodge(width = .5))+geom_linerange(aes(ymin=lcl_p,ymax=ucl_p),position=position_dodge(width = .5))+facet_grid(LWe_J~stream,scales="free",labeller =  labeller(LWe_J=c(`0`="McNary (not captured @ Lower Wen)",`1`="McNary (not captured @ McNary)")))+xlab("Smolt year")+ylab("Detection")+ylim(0,1)+ geom_point(position=position_dodge(width = .75)) + scale_x_discrete(guide = guide_axis(check.overlap = TRUE))

#time 3 (McN_J LH x stream x year)
# dev.new()
ggplot(data= as_tibble(p.design.dat)%>% filter(Time==2),aes(x=mig_year ,y=p_fit,color=LH)) + geom_point(position=position_dodge(width = .5))+geom_linerange(aes(ymin=lcl_p,ymax=ucl_p),position=position_dodge(width = .5))+facet_grid(McN_J~stream,scales="free",labeller =  labeller(McN_J=c(`0`="Bonneville (not detected @ McNary)",`1`="Bonneville (detected @ McNary)")))+ylim(0,1)+xlab("Smolt year")+ylab("Detection")+ geom_point(position=position_dodge(width = .75)) + scale_x_discrete(guide = guide_axis(check.overlap = TRUE))

#time 4-5 (stratum x year)
# dev.new()
ggplot(data= as_tibble(p.design.dat)%>% filter(Time>2),aes(x=mig_year ,y=p_fit,color=stratum))+ geom_point(position=position_dodge(width = .5))+labs(color = "Sea years") +geom_linerange(aes(ymin=lcl_p,ymax=ucl_p),position=position_dodge(width = .5))+facet_grid(~time,scales="free",labeller =  labeller(time=c(`5`="Bonneville (adult)",`6`=" McNary (adult)")))+ylim(0,1)+xlab("Return year")+ylab("Detection")+ geom_point(position=position_dodge(width = .75)) + scale_x_discrete(guide = guide_axis(check.overlap = TRUE))


```

```{r,GOF, eval=FALSE}

last_best<-mscjs_fit$mod$env$last.par.best

#mscjs_fit$Phi.design.glmmTMB$data.tmb$terms




# * observed detections data*
obs_dat<-mscjs_dat$dat_out %>% 
  #make states their own columns
  mutate(across(Bon_A :Tum_A,~as.numeric(.==2),.names="{col}_2"),.before="ch") %>% 
    mutate(across(Bon_A :Tum_A,~as.numeric(.==3),.names="{col}_3"),.before="ch") %>% 
    mutate(across(Bon_A :Tum_A,~as.numeric(.==1))) %>% 
  #multiply CH by frequency
  mutate(across(LWe_J :Tum_A_3,~.*freq)) %>% 
  #drop unneeded columns 
   select(!ch:freq) %>% 
  #sum detection by stream, year, and life history
  group_by(LH,stream,sea_Year_p) %>% summarise(across(LWe_J :Tum_A_3, sum)) %>% ungroup() 

obs_dat_long<- obs_dat%>% pivot_longer(LWe_J :Tum_A_3) %>% filter(!(LH=="Unk" & !name%in%c("McN_J","Bon_J")))

# * expected detections data*
sim<-mscjs_fit$mod$simulate(par=last_best)
exp_det_MLE<-cbind(obs_dat %>% select(LH:sea_Year_p) , sim$det_1,sim$det_2,sim$det_3) %>% `colnames<-`(colnames(obs_dat %>% select(LH :Tum_A_3))) %>% 
    #sum detection by stream, year, and life history
  group_by(LH,stream,sea_Year_p) %>% summarise(across(LWe_J :Tum_A_3, sum)) %>% ungroup() %>% pivot_longer(LWe_J :Tum_A_3) %>% filter(!(LH=="Unk" & !name%in%c("McN_J","Bon_J")))

 
 
# * posterior predictions *
sim_posterior<-rmvnorm_prec(mu=mscjs_fit$mod$env$last.par.best, 
                            prec=mscjs_fit$fit$SD$jointPrecision, 250, random_seed=1 )

FT_ref_vec<-FT_sim_vec<-numeric(250)
post_pred<-matrix(NA,nrow=nrow(exp_det_MLE),ncol=250)


options(dplyr.summarise.inform = FALSE)
gc()
for(i in 1:250){
  sim<-mscjs_fit$mod$simulate(par=sim_posterior[,i])
  

  exp_det<-cbind(obs_dat %>% select(LH:sea_Year_p) , sim$det_1,sim$det_2,sim$det_3) %>% `colnames<-`(colnames(obs_dat %>% select(LH  :Tum_A_3))) %>% 
    #sum detection by stream, year, and life history
  group_by(LH,stream,sea_Year_p) %>% summarise(across(LWe_J :Tum_A_3, sum)) %>% ungroup() %>% pivot_longer(LWe_J :Tum_A_3) %>% filter(!(LH=="Unk" & !name%in%c("McN_J","Bon_J")))

# * simulated detection from model *
sim_obs<-cbind(obs_dat %>% select(LH:sea_Year_p), sim$sim_det_1,sim$sim_det_2,sim$sim_det_3) %>% `colnames<-`(colnames(obs_dat %>% select(LH  :Tum_A_3))) %>% 
    #sum detection by stream, year, and life history
  group_by(LH,stream,sea_Year_p) %>% summarise(across(LWe_J :Tum_A_3, sum)) %>% ungroup() %>% pivot_longer(LWe_J :Tum_A_3) %>% filter(!(LH=="Unk" & !name%in%c("McN_J","Bon_J")))
  

post_pred[,i]<-sim_obs$value

#freeman Tukey
FT_ref_vec[i]<- sum((sqrt(obs_dat_long$value)-sqrt(exp_det$value))^2)
FT_sim_vec[i]<- sum((sqrt(sim_obs$value)-sqrt(exp_det$value))^2)
if((i/50)%%1==0){gc()}
}

#Bayesian P-value
sum(FT_sim_vec>FT_ref_vec)/i

#residuals
test<-(cbind(obs_dat_long %>% select(LH:name),value=((obs_dat_long$value)-(exp_det_MLE$value))))
#sum residuals across years
test %>% group_by(LH,stream,name) %>% summarise(across(value, sum)) %>% pivot_wider()
#sum residuals acorss years, streams, and LHs
test %>%  group_by(name) %>% summarise(across(value, sum))

library(DHARMa)

gc()
post_pred<-replicate(250,{
   sim_data<-mscjs_fit$mod$simulate(par=last_best)
   # * simulated detection from model *
sim_obs<-cbind(obs_dat %>% select(LH:sea_Year_p), sim_data$sim_det_1,sim_data$sim_det_2,sim_data$sim_det_3) %>% `colnames<-`(colnames(obs_dat %>% select(LH  :Tum_A_3))) %>%
    #sum detection by stream, year, and life history
  group_by(LH,stream,sea_Year_p) %>% summarise(across(LWe_J :Tum_A_3, sum)) %>% ungroup() %>% pivot_longer(LWe_J :Tum_A_3) %>% filter(!(LH=="Unk" & !name%in%c("McN_J","Bon_J")))
   sim_obs$value
})


dharm_sim<-createDHARMa(simulatedResponse = post_pred,
                        observedResponse = obs_dat_long  %>% pull(value),
                         fittedPredictedResponse = exp_det_MLE  %>% pull(value),
                        integerResponse = TRUE)
dev.new()
plot(dharm_sim,quantreg=TRUE,rank = TRUE)
testDispersion(dharm_sim)
testOutliers(dharm_sim,type = "bootstrap")


rm(obs_dat)
out_group<-recalculateResiduals(dharm_sim,group=paste(obs_dat_long$name,obs_dat_long$stream,obs_dat_long$LH))

#scaled residuals
sr<-out_group$scaledResiduals
names(sr)<-sort(unique(out_group$group))
sr
sr[sr>0.75]
sr[sr<0.25]

plot(out_group,quantreg=TRUE,rank=TRUE)
testOutliers(out_group)
plotResiduals(out_group,quantreg=FALSE,form=1:12)
out_group

mscjs_fit$par_TMB
mscjs_fit$fit$par
mscjs_fit$fit
mscjs_fit$fit$AIC
colnames(mscjs_fit$dat_TMB$X_p)
head(mscjs_fit$Phi.design.glmmTMB$data.tmb$X)


```



```{r prog_mark_mod,echo=FALSE,eval=FALSE}

#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
# Mark model for comparison
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
dat_out<-select(mark_file_CH %>% filter(LH=="smolt",stream!="White"),sea_Year_p, #grouping variables
               LWe_J, McN_J,Bon_J) %>% #sites/occasions to include in model
  #first year with all stream data through last year where data on all three return ages is available (because it is 2020)
  filter(sea_Year_p>=2007&sea_Year_p<=2016&!sea_Year_p%in%c(2011:2012)) %>%
  #make grouping variables factors
  #mutate_at(vars(sea_Year_p:stream),~as.factor(as.character(.x)))%>% mutate(McN_J=apply(select(.,McN_J,JDD_J),1,max)) %>% select(-JDD_J) %>% 
  #create multistate capture histories
  mutate(ch=select(., c(LWe_J,McN_J,Bon_J)) %>%  reduce(paste0)) %>%
  #mutate(ch=select(., McN_J,Bon_J,Est_J) %>% reduce(paste0)) %>%
  mutate(ch=paste0("1",ch)) 
# 
# dat_out<-select(mark_file_CH %>% filter(LH=="Unk"),sea_Year_p, #grouping variables
#                 McN_J,Bon_J) %>% #sites/occasions to include in model
#   #first year with all stream data through last year where data on all three return ages is available (because it is 2020)
#   filter(sea_Year_p>=2007&sea_Year_p<=2016&!sea_Year_p%in%c(2011:2012)) %>%
#   #make grouping variables factors
#   #mutate_at(vars(sea_Year_p:stream),~as.factor(as.character(.x)))%>% mutate(McN_J=apply(select(.,McN_J,JDD_J),1,max)) %>% select(-JDD_J) %>% 
#   #create multistate capture histories
#   mutate(ch=select(., c(McN_J,Bon_J)) %>%  reduce(paste0)) %>%
#   #mutate(ch=select(., McN_J,Bon_J,Est_J) %>% reduce(paste0)) %>%
#   mutate(ch=paste0("1",ch)) 


library(RMark)
wenatchee.processed=process.data(dat_out,model="CJS",groups=c("sea_Year_p"))
#wenatchee.processed=process.data(test_dat,model="MSCJS",strata.labels=c("A","B","C"))
wenatchee.ddl=make.design.data(wenatchee.processed)



#
# p
#
#
# States B&C dont exist for juveniles (times 2-5)

#wenatchee.ddl$p<-wenatchee.ddl$p[-wenatchee.ddl$p$Time<=2&wenatchee.ddl$p$stratum!="A",]
#wenatchee.ddl$S<-wenatchee.ddl$S[-wenatchee.ddl$S$Time<=2&wenatchee.ddl$S$stratum!="A",]



#column for migration year where onupstream state A is seaward year +1, b +2, and c +3
seaward_year_vec<-as.numeric(substr(wenatchee.ddl$p$sea_Year_p,2,5))
wenatchee.ddl$p$det_year<-factor(ifelse(wenatchee.ddl$p$Time<2,seaward_year_vec,ifelse(wenatchee.ddl$p$stratum==1,seaward_year_vec+1,ifelse(wenatchee.ddl$p$stratum==2,seaward_year_vec+2,seaward_year_vec+3))))



#wenatchee.ddl$p$fix=ifelse((wenatchee.ddl$p$stratum!="A"&wenatchee.ddl$p$Time<=4),0,NA)
# set detection at Tumwater adult at 100% based on other work
wenatchee.ddl$p$fix[wenatchee.ddl$p$time==9]=1


#
# Psi
#
# can only change state (other than death) at time 4
# rest are fixed values
wenatchee.ddl$Psi$fix=NA
# stay in current state (year) other than time 4 (ocean)
wenatchee.ddl$Psi$fix[wenatchee.ddl$Psi$stratum==
                        wenatchee.ddl$Psi$tostratum & wenatchee.ddl$Psi$time!=(4)]=1

wenatchee.ddl$Psi$fix[wenatchee.ddl$Psi$stratum!=
                        wenatchee.ddl$Psi$tostratum &wenatchee.ddl$Psi$time!=(4)]=0

wenatchee.ddl$Psi$fix[wenatchee.ddl$Psi$stratum!=1 &
                        wenatchee.ddl$Psi$time==4]=0



# 
# S
#
#Add a columna for whether first occasion, which is necessarily  different for subyearlings and yearlings
wenatchee.ddl$S$time_1<-ifelse(wenatchee.ddl$S$time==1,1,0)
#
#column for yearlings vs subs
wenatchee.ddl$S$Yrlng<-ifelse(wenatchee.ddl$S$LH=="smolt",1,0)
#
#columns for whether white river, which might be different because above lake Wenatchee
wenatchee.ddl$S$White<-ifelse(wenatchee.ddl$S$stream=="White",1,0)
#
#
#column for migration year where onupstream state A is seaward year +1, b +2, and c +3
seaward_year_vec<-as.numeric(substr(wenatchee.ddl$S$sea_Year_p,2,5))
wenatchee.ddl$S$det_year<-factor(ifelse(wenatchee.ddl$S$Time<2,seaward_year_vec,ifelse(wenatchee.ddl$S$stratum=="A",seaward_year_vec+1,ifelse(wenatchee.ddl$S$stratum=="B",seaward_year_vec+2,seaward_year_vec+3))))


wenatchee.ddl$S$upstream_time<-ifelse(wenatchee.ddl$S$Time>2,1,0)


# fixing S to 1 in strata where fish cant be
wenatchee.ddl$S$fix<-NA
wenatchee.ddl$S$fix[wenatchee.ddl$S$stratum!=1 &
                      wenatchee.ddl$S$Time<=3]=1 #using numeric "Time" which starts at 0 hence 3 is 4





# fit model
p.timexstratum.tag=list(formula=~-1+time)
Psi.sxtime=list(formula=~-1+tostratum)
S.stratumxtime=list(formula=~-1+time+time_1:Yrlng)


test<-RMark::mark(wenatchee.processed,wenatchee.ddl,
                  model.parameters=list(Phi=list(formula=~-1+time),p= list(formula=~-1+time)),run=TRUE)

real_test<-get.real(test,par="Phi")


upper_trap<-unlist(lapply(real_test,function(x)x$pim[1,1]))
mean(upper_trap)

plot(upper_trap,ylim=c(0,1),col="red")
# points(upper_trap,ylim=c(0,1))

mod_pred<-Phi.design.dat2 %>% filter(LH=="smolt",time%in%c(1),stream!="White",!sea_Year_p%in%c(2011:2012)) %>% group_by(sea_Year_p,time) %>% summarize(mean(phi_fit)) %>% ungroup() %>% group_by(sea_Year_p) %>% summarize(prod(`mean(phi_fit)`))
points(mod_pred[,2],ylim=c(0,1),col="blue")
mean(mod_pred %>% pull(2))

real_test$`Group:LHsmolt.streamChiwawa.sea_Year_py2007`

test$results$beta

sd_rep$value

#compare parameters
sd_rep$par.fixed - test$results$beta[,1]
#compare standard errors
sqrt(diag(sd_rep$cov.fixed)) - test$results$beta[,2]

```
\newpage

# Ignore
legacy stuff, works in progress, notes
 
$$logit(\phi^{to~McNary}_{LH,~stream,~year})=$$



Use R2ucare to evaluate the presence of trap dependency and overdispersion in the data

```{r, eval=FALSE,echo=FALSE}
library(R2ucare)

dat_out<-select(mark_file_CH,sea_Year_p,LH,stream, #grouping variables
                LWe_J:Est_J,Bon_A,McN_A:Tum_A) %>%
  #sites/occasions to include in model
  #first year with all stream data through last year where data on all three return ages is available (because it is 2020)
  mutate(adult_all = select(., Bon_A:Tum_A) %>%  reduce(pmax)) %>% #,
         # adult_all=as.numeric(adult_all>0)) %>%  # add a columnb for whether detected as an adult at all
  #make grouping variables factors
  #mutate_at(vars(sea_Year_p:stream),~as.factor(as.character(.x)))%>% mutate(McN_J=apply(select(.,McN_J,JDD_J),1,max)) %>% select(-JDD_J) %>% 
  #create multistate capture histories
  # mutate(ch=select(., McN_J:Tum_A) %>%  reduce(paste0)) %>%
  mutate(ch=select(., LWe_J,McN_J,Bon_J,adult_all) %>% reduce(paste0)) %>%
  mutate(ch=paste0("1",ch)) %>% filter(LH=="summer")


dat_out_group<-dat_out  %>% mutate(mark=1) %>% 
   # select(mark,McN_J:Tum_A,ch) %>% group_by(ch) %>% mutate(freq=n()) %>% distinct() %>% ungroup()
 select(mark,LWe_J,McN_J,Bon_J,adult_all,ch) %>% group_by(ch) %>% mutate(freq=n()) %>% distinct() %>% ungroup()

ch<-dat_out_group %>% select(mark,LWe_J,McN_J,Bon_J,adult_all) %>% as.matrix()
# ch<-dat_out_group %>% select(mark:Tum_A) %>% as.matrix()

overall_CJS(ch,dat_out_group$freq) #overall

test2ct(ch,dat_out_group$freq) #presence of trap dependence
#positive signed test indicates immediate "trap shyness" 

test3sr(ch,dat_out_group$freq) #present of transients
#positive signed test indicates an excess of never seen again among the newly marked

test3sm(ch,dat_out_group$freq) #overdispersion

test2cl(ch,dat_out_group$freq) #overdispersion


#multistate test

overall_JMV(ch,dat_out_group$freq)

# past encounter history should not matter (memory and transience)
test3Gsr(ch,dat_out_group$freq) #transients
test3Gsm(ch,dat_out_group$freq) #complementary composite
test3Gwbwa(ch,dat_out_group$freq) # memory

testMitec(ch,dat_out_group$freq) # local trap hapiness
testMltec(ch,dat_out_group$freq)







mar_test<-R2ucare::marray(dat_out_group %>% select(mark:Tum_A) %>% as.matrix(),dat_out_group$freq)

mar_test$R
mar_test$m
mar_test$never

test2ct(dat_out_group %>% select(mark:adult_all) %>% as.matrix(),dat_out_group$freq)

test2cl(dat_out_group %>% select(mark:adult_all) %>% as.matrix(),dat_out_group$freq)

# Frequency of capture histories
 sort(tapply(mscjs_dat$dat_out$freq,mscjs_dat$dat_out$ch,sum))


```

Run time-dependent model in JAGS 

```{r, eval=FALSE}

sink("cjs-mnl.jags")
cat("
model {
# Priors and constraints
for (t in 1:(n.occasions-1)){
   phi[t] ~ dunif(0, 1)         # Priors for survival
   p[t] ~ dunif(0, 1)           # Priors for recapture
   }
# Define the multinomial likelihood
for (t in 1:(n.occasions-1)){
   marr[t,1:n.occasions] ~ dmulti(pr[t, ], rel[t])
   }
# Define the cell probabilities of the m-array
# Main diagonal
for (t in 1:(n.occasions-1)){
   q[t] <- 1-p[t]                # Probability of non-recapture
   pr[t,t] <- phi[t]*p[t]
   # Above main diagonal
   for (j in (t+1):(n.occasions-1)){
      pr[t,j] <- prod(phi[t:j])*prod(q[t:(j-1)])*p[j]
      } #j
   # Below main diagonal
   for (j in 1:(t-1)){
      pr[t,j] <- 0
      } #j
   } #t
# Last column: probability of non-recapture
for (t in 1:(n.occasions-1)){
   pr[t,n.occasions] <- 1-sum(pr[t,1:(n.occasions-1)])
   } #t

}
",fill = TRUE)
sink()

# Create the m-array from the capture-histories
marr <- cbind(mar_test$m[,,1],mar_test$never)

# Bundle data
jags.data <- list(marr = marr, n.occasions = dim(marr)[2], rel = rowSums(marr))

# Initial values
inits <- function(){list(phi = runif(dim(marr)[2]-1, 0, 1), p = runif(dim(marr)[2]-1, 0, 1))}  

# Parameters monitored
parameters <- c("phi", "p")

# MCMC settings
ni <- 10000
nt <- 3
nb <- 5000
nc <- 3

# Call JAGS from R 
library(R2jags)

cjs <- jags(jags.data, inits, parameters, "cjs-mnl.jags", n.chains = nc, n.thin = nt, n.iter = ni, n.burnin = nb, working.directory = getwd())

print(cjs, digits = 3) 





```


