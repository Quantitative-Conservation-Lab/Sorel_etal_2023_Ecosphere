---
title: "Survival and age at maturation of juvenile spring Chinook emigrants from Chiwawa, Nason and White River"
author: "Mark Sorel"
date: "12/17/2020"
output: html_document
---



## Introduction

One of the most important aspects of population dynamics is stochasticity (Lande et al. 2003). Environmental stochasticity is the variability in environmental factors like weather that affect demographic rates, whereas demographic stochasticity refers to variability in demographic outcomes given vital rates. Both types of stochasticity can have strong effects on abundance and extinction risk and tend to be primary drivers of population dynamics for marine fish populations. 

Another primary driver of population dynamics is individual heterogeneity (Pfister and Stevens 2003). Variability exists among individuals of a population in traits, such as growth rate, that are related to demographic rates like survival. Furthermore, individual heterogeneity can interact with stochasticity to determine demographic variability through time and space (Vindenes et al. 2008). Including individual heterogeneity in population models can enable more accurate characterization of population dynamics and provide valuable insights into the drivers of population dynamics (Conner and White 1999). 

For certain populations of Chinook salmon, it may be necessary to develop models of demographic rates that account for both stochasticity and individual heterogeneity. Salmon are subject to substantial environmental variability, which has large effects on survival, especially in the marine environment (Zabel et al. 2006). They also exhibit considerable variation in traits, such as the timing of juvenile emigration from natal streams and age at maturity (Copeland and Venditti 2009). Juveniles that emigrate from natal streams at different times and at different sizes are likely to have different survival rates in subsequent life stages and may also be diferentially affected by variable environments (Copeland et al. 2014).

In this chapter, I will characterize how Chinook salmon survival and age at return vary through time due to stochasticity and due to individual heterogeneity (i.e., the timing of emigration from natal streams). Characterizing variability in vital rates is key to ultimately evaluating extinction risk, which can inform how management actions such as hatchery supplementation can be deployed to prevent extinction. Characterizing how the timing of juvenile emigrants affects their subsequent survival and age at maturity will enable more mechanistic predictions of the effect of different habitat restoration treatments on population dynamics. I will also evaluate how survival is related to environmental variables like river temperature and sea surface temperature, to enable simulation of the effects of climate warming on survival, in future analyses. 


## Methods

### Study system


- Spring Chinook
  - Juvenile behavior from emigration from natal stream to smolting
  - Downstream migration
  - Ocean
  - Upstream
- Wenatchee / Columbia Rivers
  - Hydrograph/ thermal regime
  - Hydrosystem
    - Fish passage
      -Downstream / upstream
- Marine  
  
We studied a population of spring run Chinook salmon that spawns in the Wenatchee River basin as a case study for model development and to learn about how vital rates vary among among streams and juvenile life histories, as well as their associations with environmental covariates. The Wenatchee River is a tributary of the upper Columbia River (RKm 754) located in north-central Washington State, with a drainage area of roughly 3,437 km2 (Figure 1).The population of spring Chinook salmon in the Wenatchee River has been intensively monitored since the mid 1990's due to its endangered status under the ESA and to evaluate the efficacy of a conservation hatchery program that serves as mitigation for impacts on fish of hydroelectric dams on the main stem of the Columbia River. 

The population is considered a spring run due to the early return timing of adults from the ocean. This early return timing, before adults have fully matured, is an adaptation to allow for increased access to high elevation spawning reaches prior to the onset of low flows and high temperatures during the summer, however, adults don't spawn until early fall. Juveniles emerge from the gravel in late winter and in the Columbia River basin tend to exhibit a stream-type life history, wherein they rear in freshwater extensively prior to migrating to the marine environment (smolting). The most common juvenile life history for spring Chinook salmon populations in the Columbia River Basin is to smolt in their second spring, just over a year following emergence. Wenatchee River spring Chinook express this juvenile life history with remarkable consistency, whereas other species of anadromous salmonids and other populations of Chinook exhibit more life history diversity in terms of  age at smolting. 

Spring Chinook salmon do exhibit considerable life hitory diversity with regards to dispersal from natal sites for freshwater rearing, however. Spawning tends to occur in the upper reaches or watersheds and some juveniles disperse to use downstream rearing habitats, while others remain in natal areas until smolting. This diversity in juvenile freshwater habitat use appears to provide a stabilizing effect on the population and may increase the capacity of freshwater habitat to support juveniles rearing, however, it complicates monitoring because juveniles are often enumerated when emigrating from their natal reach. Juvenile emigrating from natal reaches at different times of year will have different survival rates to adulthood and use different habitats, so understanding their survival following emigration is paramount to understanding the contribution of different dispersal strategies to population productivity.  

Regardless of their dispersal behavior and rearing habitat within freshwater, nearly all juveniles smolt during their second spring. When migrating to the ocean, juvenile salmon and steelhead from the Wenatchee River must pass three hydroelectic Dams on the upper Columbia River above the confluence with the Snake River: Rock Island Dam (rkm 729), Wanapum Dam (rkm 668), and Priest Rapids Dam (rkm 639) (Figure 1). They pass an additional four dams on the main stem of the Columbia River downstream of the confluence with the Snake River: McNary Dam (rkm 470), John Day Dam (rkm 347), The Dalles Dam (rkm 307), and Bonneville Dam (rkm 234). All seven dams are equipped with systems to divert fish away for turbines and into pathways designed to pass juvenile fish downstream. In addition, when water is spilled over top of dams fish may pass dams via the spillways. The hydrograph of the Columbia River is regulated by the storage and release of water from manmade reservoirs in it's upper reaches and tributaries. While regulation has reduced the magnitude of the spring freshet, water is released from storage reservoirs during the spring smolt migration and water is spilled over dams in the migration corridor to aid fish migration and dam passage. 

Once fish enter the marine environment, Columbia River spring Chinook generally swim northward to the productive marine waters in the Gulf of Alaska, and reside off the continental shelf for one to three years before returning to the Columbia River in spring. The majority of adults spend two years at sea, and most fish that spend only one year at sea are males (known as Jacks). Upstream migrating salmon pass dams via fish ladders, that provide flowing water at an appropriate gradiant and with holding pools such that fish are attracted to and able to navigate upstream through them. In addition to the dams on the Columbia River, fish must pass Tumwater Dam on the main stem of the Wenatchee River (RkM ___) (Figure 1). This dam is no longer used for power generation and is equipped with adult fish passage facilties. 


### Data
- Map
- Juvenile tagging
  - Capture
  - Taging
  - Timing
  
- Detection
  - Juvenile bypasses 
    - Length effects
  - Adult fish ladders
  
A sample of juvenile spring Chinook salmon were captured with rotary screw traps (*cite*) when emigrating from three natal tributaries - the Chiwawa River, Nason Creek, and the White River (Figure 1). The traps were installed in early spring and operated continuously through late fall. From 2006 through 2016, captured juveniles > 60 mm were implanted with passive integrated transponder (PIT) tags within their peritoneal cavity using a syringe. *Add information on tag loss and tagging mortality*. Each PIT tag had a unique radio-frequency identification (RFID) code that transmitted when triggered by an electromagnetic interrogation pulse from an RFID reader device. 

Fish-passage pathways for both juveniles and adults at certain dams were equipped with RFID reader devices, and the ID codes and timing of fish using these pathways was recorded. We used the detection histories of individuals passing dams to learn about their survival and age at maturation. Specifically, we used detections of juveniles of juveniles at McNary and Bonneville Dams, and defections of Adults at Bonneville, McNary, Priest Rapids, Rock Island, and Tumwater Dams. Only juveniles which passed via the turbine-bypass pathways had the change of to be detected, as there were no RFID readers in the spillways or the turbine penstocks. The dates and locations that marked fish were released and subsequent detected at dams were downloaded from the Columbia Basin PIT Tag Information System (data citation).  

Table. Detectios by site and year.

```{r, load_data}
library(here)
source(here("src","Wen_MSCJS_re.R"))

site_year_det<-select(mark_file_CH,sea_Year_p,McN_J:Tum_A) %>% group_by(sea_Year_p) %>% summarise_all(function(x)sum((x>0))) %>% print(n=100)
#not using TDD_A or JDD_A currently because of missing years and relatively good detection upstream.
knitr::kable(site_year_det)
```

Either 2020 adult detection data were not uploaded yet or there were no 2020 adult detections. I will stop with downstream migration year 2016 for now, which would return as adults through 2019. Also, the first year (2003) is followed by a three year "gap", so I will start the analysis with the 2006 downstream migration year. 

For whatever reason, when I include JDD_J (John Day Dam juvenile) in the model, it has trouble converging. I'm not totally sure what's going on there, but I am going to exclude it for now and just model survival from McN_J to Bon_J. Adult detection at the The Dalles Dam (TDD_A) and John Day Dam (JDD_A) started in 2010 and 2015 respectively and could be included in the model with detection fixed at 0.0 before then, but I am excluding those sites for now. 


### Model
- Multistate CJS
  - Survival
  - Detection
  - Age at return
  - Assumptions
  
- "Group covariates"
  - Stream
  - LH
  - stratum
  - year
  - envrionmental
    
- Likelihood
  - Transition matrices
    - migration
    - ocean
  - Observation matrices
  - Assuming adult detection at Tumwater is 1
  
- Full model
- Reduced models
  - Variable selection
- Goodness of fit testing
  - UCare

We used a multistate Cormack-Jolly-Seber model to estimate survival rates and adult-return ages (*check term used for consistency throughout*), where the states corresponded with the number of years spent at sea. Therefore, for all intervals other than that between when juveniles passed downstream of Bonneville Dam and when they passed upstream of Bonneville Dam as adults, the only possible state transition was between their current state and the dead state. Only during the ocean-residence period could fish transition between multiple states, returning as 3, 4, or 5 year-olds. However, once smolts passed downstream of Bonneville Dam, they could not have been detected again until they returned to the Columbia River and passed upstream of Bonneville Dam, so probabilities of marine-survival were confounded with probabilities of returning at alternative ages and only the joint probabilities of survival and return age were identifiable (Buchanan and Skalski 2007).  

We considered 4 group covariates over which vital rates and detection probabilities might vary: juvenile life history strategy, natal stream, year, and adult age. The first time period in the model was between juvenile emigration from their natal stream and when they passed McNary Dam en route to the ocean. However, the length of time that this period represented varied from nearly a year for the earliest emigrating juveniles to as little as several days for fish that reared entirely within the natal stream. To account for the heterogeneity in survival rates that this range of elapsed times would cause, we divided fish into three juvenile life-history groups, that corresponded with modes of emigration timing from the natal stream delineated in previous work (Chapter 1). The earliest emigrating juveniles from the natal stream (hereafter summer emigrants), emigrated as subyearlings between day of year 141 and 262. The subsequent group of emigrants (hereafter fall emigrants), emigrated as subyearlings from day of year 263 through when the traps were removed in early winter. The final group of emigrants (hereafter "smolts"), emigrated as yearlings in spring (day of year 53-179), and were delineated from subyearlings based on a previously developed length-date cutoff rule (chapter 1). We also considered whether fish in these different groups had different survival, maturation age, and detection probabilities at subsequent life stages, as could result from variation in vitality or growth rates of fish that expressed different juvenile life histories. We also considered whether vital rates and detection probabilities could vary among fish from different natal streams, among years, and for different aged adults during their upstream migration.    

### look at #s released and detected at different dams by life history (LH), stream, and site.
```{r, data_examine}
select(mark_file_CH,sea_Year_p,LH,stream,McN_J:Tum_A) %>% group_by(LH,stream) %>% summarise_all(function(x)sum((x>0)))%>% rename(released=sea_Year_p)%>% print(n=100)
#no adult detections of white summer and few for white fall and smolt

```

Numbers's of detections quite low for some stream x life history combinations, especially adults. 0 adult detections of White river summer emigrants. 


A multistate Cormack-Jolly-Seber model is a class of Hidden Markov Model and therefore the likelihood of a given capture history $x$ at occasions 1 through T can be calculated using the forward algorithm,

$$\mathcal{L}\left(\theta\mid x_1,\ldots,x_T\right)=\delta P\left(x_1\right)\Gamma P\left(x_2\right)\cdots\Gamma P\left(x_{T-1}\right)\Gamma P\left(x_T\right)1$$
where $\theta$ is a vector of probabilities of survival ${\phi}_{t,l,a,y,s}$ , maturation $\psi_{l,a,y,s}$, and detection ${p}_{t,l,a,y,s}$. In the likelihood, $\delta$ is the initial distribution vector of state probabilities at release, ${P}$ are state-dependent distributions that are diagonal matrices of conditional probabilities of observations given a fish is in each state, $\Gamma$ are state transition probability matrices specifying the probability of transitioning from each state at time t to each state at time t + 1, and $\mathbf{1}$ is a column vector of ones (See Zucchini et al. 2016 or McClintock et al. 2020 for details on the forward algorithm for hidden Markov models). 

The initial probability vector represents a probability of 1.0 that fish are alive at release.

Transition matrix for all intervals other than the marine-residence interval.
$$
\begin{array}{rccc}

      &  Alive   & Dead \\
    Alive &  \phi_{t,l,a,y,s} &  1-\phi_{t,l,a,y,s} \\
 
    Dead & 0 &1 \\

\end{array}
$$



Transition matrix for the marine-residence interval
$$
\begin{array}{rccc}

 & 3~year~old & 4~year~old  & 5~year~old & dead \\
  
    Alive &  \phi_{l,a,y}(1-\psi_{l,a,y,1}) & \phi_{l,a,y}(1-\psi_{l,a,y,2}) & \phi_{l,a,y}(1-\psi_{l,a,y,3}) & 1-\phi_{i,t,y} \\
    Dead & 0 & 0 &  0 &1 \\


\end{array}
$$

Observation matrix
$$
\begin{array}{rccc}

      &  Detected   & Not~ detected \\
    Alive &  p_{t,l,a,y,s} &  1-p_{t,l,a,y,s} \\
 
    Dead & 0 &1 \\

\end{array}
$$
 
The detection rate of adults passing Tumwater Dam was fixed at 1 for parameter identifiability and because the proportion of PIT-tagged adults detected upstream of Tumwater Dam that were also detected at Tumwater Dam aproaches 1 (supplement). 
 

Survival and detection probabilities were modeled using a logit link.

The joint probability of marine survival and age at maturation was modeled as follows. The marginal probability of survival across all return ages corresponding with a given year of marine entry was modeled with a logit link. The conditional probabilities of returning at ages 3, 4, or 5 given a fish survived was modeled using a multinomial logit link. This formulation was chosen because it is believed that much of the variability in smolt-to-adult survival is determined within the first year or even the first weeks of marine residence and therefore affects the total number of returning adults of all ages. Our formulation allowed us to model interannual variability in the marginal survival probability of adults returning at all ages. The conditional probabilities of survivors returning at different ages therefore represented variability in survival rates after the first year and in the probabilities that fish of different ages residing within the ocean returned to the Columbia River.




Look at the distributions of tagged fish's lengths vs lengths of fish captured in the screw trap. Same for day of year. Grey is fish captured in the screw trap and red is tagged.
```{r, examine_tag_distribution}
ggplot(all_bio_data,aes(x=Length))+geom_density(alpha=.5,fill="black",color=NA)+facet_wrap(~LH,scales = "free_y")+geom_density(data=mark_file_CH,aes(x= `Length mm`), alpha=.5,fill="red",color=NA)

ggplot(all_bio_data,aes(x=DOY))+geom_density(alpha=.5,fill="black",color=NA)+facet_wrap(~LH,scales = "free_y")+geom_density(data=mark_file_CH,aes(x=`Mark Day Number`), alpha=.5,fill="red",color=NA)

```

Takeaway: there is definitely a bias toward larger and later fish during summer being tagged (because their is a size cutoff for how small of a fish can be tagged - 60 mm). We will need to address this somehow. ALso, no fry tagged. Going to worry about this later.



Use R2ucare to evaluate the presence of trap dependency and overdispersion in the data

```{r}
library(R2ucare)

dat_out<-select(mark_file_CH,sea_Year_p,LH,stream, #grouping variables
                McN_J:Est_J,Bon_A,McJ_A:Tum_A) %>% #sites/occasions to include in model
  #first year with all stream data through last year where data on all three return ages is available (because it is 2020)
  mutate(adult_all = select(., Bon_A:Tum_A) %>%  reduce(pmax),
         adult_all=as.numeric(adult_all>0)) %>%  # add a columnb for whether detected as an adult at all
  #make grouping variables factors
  #mutate_at(vars(sea_Year_p:stream),~as.factor(as.character(.x)))%>% mutate(McN_J=apply(select(.,McN_J,JDD_J),1,max)) %>% select(-JDD_J) %>% 
  #create multistate capture histories
  mutate(ch=select(., McN_J:Est_J,adult_all) %>%  reduce(paste0)) %>%
  #mutate(ch=select(., McN_J,Bon_J,Est_J) %>% reduce(paste0)) %>%
  mutate(ch=paste0("1",ch)) 


dat_out_group<-dat_out  %>% mutate(mark=1) %>% 
   select(mark,McN_J:Est_J,adult_all,ch) %>% group_by(ch) %>% mutate(freq=n()) %>% distinct() %>% ungroup()

mar_test<-R2ucare::marray(dat_out_group %>% select(mark:adult_all) %>% as.matrix(),dat_out_group$freq)

mar_test$R
mar_test$m
mar_test$never

test2ct(dat_out_group %>% select(mark:adult_all) %>% as.matrix(),dat_out_group$freq)

test2cl(dat_out_group %>% select(mark:adult_all) %>% as.matrix(),dat_out_group$freq)

# Frequency of capture histories
 sort(tapply(mscjs_dat$dat_out$freq,mscjs_dat$dat_out$ch,sum))


```




```{r, process_dat,echo=FALSE}
mscjs_dat<- make_dat(mark_file_CH,sites=c( #"McN_J",
  #"JDD_J",
  "Bon_J",
  #"Est_J",
  "Bon_A","McJ_A","PRa_A","RIs_A","Tum_A"))
```

```{r, fit full model}
# "null" model
mscjs_fit3<-fit_wen_mscjs(x=mscjs_dat,
                         phi_formula=par.index~
                           
                           #fixed effect
                           -1+ time +time1:LHsmolt+time1:LHsummer,
                      
                         p_formula= par.index~
                           #fixed effects
                           -1+ time,
                         
                         psi_formula= par.index~
                           #fixed effects
                           tostratum,
                           #random effects
                         # (0+tostratum|mig_year),
                         
                         doFit = TRUE,silent=TRUE
)

mscjs_fit$fit$opt
colnames(mscjs_fit$dat_TMB$X_p)



#experimental

mscjs_fit<-fit_wen_mscjs(x=mscjs_dat,
                         phi_formula=par.index~
                           
                           # fixed effect
                           ## occasion-specific intercepts (Chiwawa Fall by default)
                           -1+ time + #
                           
                           ## survival to McNary 
                           time1:LHsmolt+time1:LHsummer+
                           time1:streamWhite:LHsummer+time1:streamWhite+time1:streamWhite:LHsmolt+ 
                           time1:streamNason:LHsummer+time1:streamNason+time1:streamNason:LHsmolt+
                           ## survival to Bonneville Juvenile
                           time2:LHsmolt + time2:LHsummer+
                           ## survivalto Bonneville Adult
                           time3:LHsmolt + time3:LHsummer+
                           ## effect of being a jack on upstream survival
                           `1` +
                           
                           #random effects
                           cs(0+time1:stream:LH|mig_year)+ # to McNary juvenile
                           diag(0+time2|mig_year)+ #to Bonneville Juvenile
                           diag(0+time3|mig_year)+ #to Bonneville Adult
                           diag(0+time4|mig_year)+ #to McNary Adult
                           diag(0+time5|mig_year)+ #to Priest Rapids Adult
                           diag(0+time6|mig_year)+ #to Rock Island Adult
                           diag(0+time7|mig_year), #to Tumwater Dam Adult
                           
                           
                         p_formula= par.index~
                           ## fixed effects
                           -1+ time+
                           ## McNary juvenile detection
                           time2:streamWhite+time2:streamNason+#McNary detection
                           time2:LHsummer+time2:LHsmolt+
                           ## Bonneville juvenile
                           time3:LHsummer+time3:LHsmolt+
                    
                          # random effects
                           diag(0+time2|mig_year)+  #McNary Juveniles
                           diag(0+time3|mig_year)+  #John Day Juveniles
                           diag(0+time4|mig_year)+ # Bonneville Juvenile
                           diag(0+time5|mig_year)+ # Bonneville Adult
                           diag(0+time6|mig_year)+ # McNary Adult
                           diag(0+time7|mig_year)+ #Priest Rapids Adult
                           diag(0+time8|mig_year), #Rock Island Adult
                         # final detection (tumwater) fixed at 1.0
                         

                         
                         psi_formula= par.index~
                           #fixed effects
                           tostratum+
                           tostratum:LHsmolt+
                           #random effects
                         (0+tostratum|mig_year),
                         
                         
                         doFit = TRUE
)



#"full" model

mscjs_fit<-fit_wen_mscjs(x=mscjs_dat,
                         phi_formula=par.index~
                           
                           #fixed effect
                           -1+ time + #occasion
                           time:LH + #occasion:life history
                           time1:streamWhite+time1:streamNason+#survival to McNary 
                           time1:streamWhite:LHsummer+time1:streamWhite:LHsmolt+ 
                           time1:streamNason:LHsummer+time1:streamNason:LHsmolt+
                           time2:streamWhite+time2:streamNason+#to Bonneville
                          time3:streamWhite+time3:streamNason+#to Bonneville Adult
                           # time2:streamWhite:LHsummer+time2:streamWhite:LHsmolt+ 
                           # time2:streamNason:LHsummer+time2:streamNason:LHsmolt+
                           # time4:streamWhite+time4:streamNason+ #to Bonneville Adult
                           `1`+ #stratum upstream
                           
                           #random effects
                           cs(0+time1:stream:LH|mig_year)+ # to McNary
                           diag(0+time2|mig_year)+ #to John Day Juvenile
                           diag(0+time3|mig_year)+ #to Bonneville Juvenile
                           diag(0+time4|mig_year)+ #to Bonneville Adult
                           diag(0+time5|mig_year)+ #to McNary Adult
                           #diag(0+time6|mig_year)+ #to Priest Rapids Adult
                           diag(0+time7|mig_year), #to Rock Island Adult
                           # diag(0+time8|mig_year), #to Tumwater Dam Adult

                           
                         p_formula= par.index~
                           #fixed effects
                           -1+ time+time:LH+
                           time2:streamWhite+time2:streamNason+#McNary detection
                           time2:streamWhite:LHsummer+time2:streamWhite:LHsmolt+
                           time2:streamNason:LHsummer+time2:streamNason:LHsmolt+
                           time3:streamWhite+time3:streamNason+#Bonneville juvenile
                           # time3:streamWhite+time3:streamNason+#Bonneville juvenile
                         `1`+#stratum upstream
                          #random effects
                           diag(0+time2|mig_year)+  #McNary Juveniles
                           diag(0+time3|mig_year)+  #John Day Juveniles
                           diag(0+time4|mig_year)+ # Bonneville Juvenile
                           #diag(0+time5|mig_year)+ # Bonneville Adult
                           diag(0+time6|mig_year)+ # McNary Adult
                           diag(0+time7|mig_year), #Priest Rapids Adult
                         # final detection (tumwater) fixed at 1.0
                         

                         
                         psi_formula= par.index~
                           #fixed effects
                           tostratum+
                           tostratum:LH+
                           tostratum:stream+
                           #random effects
                         (0+tostratum|mig_year),
                         
                         
                         doFit = TRUE
)


mscjs_fit$Phi.design.glmmTMB$data.tmb$terms
```

```{r print_outputs}
#function that prints random effect standard deviations and correlations in a nice table
print_cov<-function(param){
mat_out<-matrix(NA,nrow=0,ncol=4+100,dimnames = list(c(),c("Groups","Name","Std.Dev","SD(SD)","Corr",rep("",99))))
ind<-0
for(i in 1:length(mod_rep[[paste0("sd_",tolower(param))]])){
ind2<-ind+length(mod_rep[[paste0("sd_",tolower(param))]][[i]])

##RE variance
value<-ad_rep_vals[names(ad_rep_vals)==paste0("exp(theta_",tolower(param),")")][(ind+1):ind2]

###SE
sd_val<-ad_rep_sds[names(ad_rep_vals)==paste0("exp(theta_",tolower(param),")")][(ind+1):ind2]
##lower tri corr
cor_mat<-mod_rep[[paste0("corr_",tolower(param))]][[i]]
cor_mat[upper.tri(cor_mat,TRUE)]<-NA

##combine
mat_i<-matrix(NA,nrow=length(value),ncol=4+100,dimnames = list(rep("",length(value)),c("Groups","Name","Std.Dev","SD(SD)","Corr",rep("",99))))
mat_i[1,1]<-mscjs_fit[[paste0(param,".design.glmmTMB")]]$grpVar[i]
mat_i[,2]<-mscjs_fit[[paste0(param,".design.glmmTMB")]]$condList$reTrms$cnms[i][[1]]
mat_i[,3]<-round(value,4)
mat_i[,4]<-round(sd_val,4)
if(ncol(cor_mat)>0){ mat_i[,5:(4+ncol(cor_mat))]<-round(cor_mat,4)
}
mat_out<-rbind(mat_out,mat_i)

ind<-ind2

}
print(mat_out[,apply(mat_out,2,function(x)sum(!is.na(x)))>0],na.print = "",quote = FALSE)
}

#mscjs_fit$fit$time_for_run
mscjs_fit$fit$time_for_MLE
mscjs_fit$fit$time_for_sdreport

#sd report
#sd_rep<-sdreport(mod)
#sd_rep
fixed_est<-mscjs_fit$fit$SD$par.fixed
fixed_sd<-sqrt(diag(mscjs_fit$fit$SD$cov.fixed))

#report
mod_rep<-mscjs_fit$mod$report()
#ad report
ad_rep_vals<-mscjs_fit$fit$SD$value
ad_rep_sds<-mscjs_fit$fit$SD$sd


print("Phi")
print("fixed")
tibble(par_name=colnames(mscjs_fit$Phi.design.glmmTMB$data.tmb$X),estimate=fixed_est[1:length(mscjs_fit$par_TMB$beta_phi)],sd=fixed_sd[1:length(mscjs_fit$par_TMB$beta_phi)]) %>%  mutate(p_value= round(2*pnorm(abs(estimate/sd), lower.tail = FALSE),3)) %>% print(n=100)
print("Random covariance")
print_cov("Phi")





print("p")
print("fixed")
tibble(par_name=colnames(mscjs_fit$p.design.glmmTMB$data.tmb$X),estimate=fixed_est[seq(from=(length(mscjs_fit$par_TMB$beta_phi)+1),length=length(mscjs_fit$par_TMB$beta_p))],sd=fixed_sd[seq(from=(length(mscjs_fit$par_TMB$beta_phi)+1),length=length(mscjs_fit$par_TMB$beta_p))]) %>%  mutate(p_value= round(2*pnorm(abs(estimate/sd), lower.tail = FALSE),3)) %>% print(n=100)
print("Random covariance")
print_cov("p")


print("Psi")
print("fixed")
tibble(par_name=colnames(mscjs_fit$Psi.design.glmmTMB$data.tmb$X),estimate=fixed_est[seq(from=(length(mscjs_fit$par_TMB$beta_phi)+length(mscjs_fit$par_TMB$beta_p)+1),length=length(mscjs_fit$par_TMB$beta_psi))],sd=fixed_sd[seq(from=(length(mscjs_fit$par_TMB$beta_phi)+length(mscjs_fit$par_TMB$beta_p)+1),length=length(mscjs_fit$par_TMB$beta_psi))]) %>%  mutate(p_value= round(2*pnorm(abs(estimate/sd), lower.tail = FALSE),3)) %>% print(n=100)
print_cov("Psi")


# random effect standard deviations and correlations

mod_rep$sd_p
mod_rep$corr_p
mod_rep$sd_psi
mod_rep$corr_psi

mscjs_fit$fit$AIC


mscjs_fit$mod$env$last.par.best



```


```{r plot_output?}
head(mod_rep$psi)
mod_rep$phi[1:20]
mod_rep$p[1:3]
sd_rep<-mscjs_fit$fit$SD

Phi.design.dat2 <- mscjs_dat$Phi.design.dat%>% mutate(phi_fit=mod_rep$phi,
                                            eta_phi= sd_rep$value[names(sd_rep$value)=="eta_phi"],
                                            eta_phi_sd=sd_rep$sd[names(sd_rep$value)=="eta_phi"],
                                            lcl_phi=plogis(qnorm(.025,eta_phi,eta_phi_sd)),
                                            ucl_phi=plogis(qnorm(.975,eta_phi,eta_phi_sd))) %>% 
  mutate(LH=fct_relevel(LH,"summer","fall","smolt"))

# Phi.design.dat2<-Phi.design.dat2 %>% select(time ,stratum , LH , stream ,mig_year, phi_fit)

p.design.dat <- mscjs_dat$p.design.dat %>% mutate(p_fit=mod_rep$p,
                                            eta_p=sd_rep$value[names(sd_rep$value)=="eta_p"],
                                            eta_p_sd=sd_rep$sd[names(sd_rep$value)=="eta_p"],
                                            lcl_p=plogis(qnorm(.025,eta_p,eta_p_sd)),
                                            ucl_p=plogis(qnorm(.975,eta_p,eta_p_sd)))


  

dev.new()
ggplot(data= as_tibble(Phi.design.dat2),aes(x=(mig_year) ,y=phi_fit,color=stream)) + geom_point(position=position_dodge(width = .75))+geom_linerange(aes(ymin=lcl_phi,ymax=ucl_phi),position=position_dodge(width = .75))+facet_grid(rows=vars(time),cols=vars(LH))

dev.new()
ggplot(data= as_tibble(p.design.dat),aes(x=as.numeric(mig_year) ,y=p_fit,color=stream)) + geom_point(position=position_dodge(width = .75))+geom_linerange(aes(ymin=lcl_p,ymax=ucl_p),position=position_dodge(width = .75))+facet_grid(rows=vars(time),cols=vars(LH))

ggplot(data= as_tibble(p.design.dat),aes(x=as.numeric(mig_year) ,y=p_fit,color=LH)) + geom_point(position=position_dodge(width = .5))+geom_line(position=position_dodge(width = .5))+geom_linerange(aes(ymin=lcl_p,ymax=ucl_p),position=position_dodge(width = .5))+facet_wrap(~time,scales="free")


par_list<-mod$env$parList(par=mod$env$last.par.best)
length(par_list$b_phi)

acf(par_list$b_phi[seq(from=((13*2)+1),length=13)])

#stacked barplot percent age at return
dev.new()


#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
# Mark model for comparison
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
dat_out<-select(mark_file_CH,sea_Year_p,LH,stream, #grouping variables
                McN_J:Bon_J,Bon_A,McJ_A:Tum_A) %>% #sites/occasions to include in model
  #first year with all stream data through last year where data on all three return ages is available (because it is 2020)
  filter(sea_Year_p>=2007&sea_Year_p<=2016) %>%
  #make grouping variables factors
  #mutate_at(vars(sea_Year_p:stream),~as.factor(as.character(.x)))%>% mutate(McN_J=apply(select(.,McN_J,JDD_J),1,max)) %>% select(-JDD_J) %>% 
  #create multistate capture histories
  mutate(ch=select(., c(McN_J:Bon_J,Bon_A,McJ_A:Tum_A)) %>%  reduce(paste0)) %>%
  #mutate(ch=select(., McN_J,Bon_J,Est_J) %>% reduce(paste0)) %>%
  mutate(ch=paste0("1",ch)) 

library(RMark)
wenatchee.processed=process.data(dat_out,model="Multistrata",groups=c("LH"))
#wenatchee.processed=process.data(test_dat,model="MSCJS",strata.labels=c("A","B","C"))
wenatchee.ddl=make.design.data(wenatchee.processed)



#
# p
#
#
# States B&C dont exist for juveniles (times 2-5)

#wenatchee.ddl$p<-wenatchee.ddl$p[-wenatchee.ddl$p$Time<=2&wenatchee.ddl$p$stratum!="A",]
#wenatchee.ddl$S<-wenatchee.ddl$S[-wenatchee.ddl$S$Time<=2&wenatchee.ddl$S$stratum!="A",]



#column for migration year where onupstream state A is seaward year +1, b +2, and c +3
seaward_year_vec<-as.numeric(substr(wenatchee.ddl$p$sea_Year_p,2,5))
wenatchee.ddl$p$det_year<-factor(ifelse(wenatchee.ddl$p$Time<2,seaward_year_vec,ifelse(wenatchee.ddl$p$stratum==1,seaward_year_vec+1,ifelse(wenatchee.ddl$p$stratum==2,seaward_year_vec+2,seaward_year_vec+3))))



#wenatchee.ddl$p$fix=ifelse((wenatchee.ddl$p$stratum!="A"&wenatchee.ddl$p$Time<=4),0,NA)
# set detection at Tumwater adult at 100% based on other work
wenatchee.ddl$p$fix[wenatchee.ddl$p$time==9]=1


#
# Psi
#
# can only change state (other than death) at time 4
# rest are fixed values
wenatchee.ddl$Psi$fix=NA
# stay in current state (year) other than time 4 (ocean)
wenatchee.ddl$Psi$fix[wenatchee.ddl$Psi$stratum==
                        wenatchee.ddl$Psi$tostratum & wenatchee.ddl$Psi$time!=(4)]=1

wenatchee.ddl$Psi$fix[wenatchee.ddl$Psi$stratum!=
                        wenatchee.ddl$Psi$tostratum &wenatchee.ddl$Psi$time!=(4)]=0

wenatchee.ddl$Psi$fix[wenatchee.ddl$Psi$stratum!=1 &
                        wenatchee.ddl$Psi$time==4]=0



# 
# S
#
#Add a columna for whether first occasion, which is necessarily  different for subyearlings and yearlings
wenatchee.ddl$S$time_1<-ifelse(wenatchee.ddl$S$time==1,1,0)
#
#column for yearlings vs subs
wenatchee.ddl$S$Yrlng<-ifelse(wenatchee.ddl$S$LH=="smolt",1,0)
#
#columns for whether white river, which might be different because above lake Wenatchee
wenatchee.ddl$S$White<-ifelse(wenatchee.ddl$S$stream=="White",1,0)
#
#
#column for migration year where onupstream state A is seaward year +1, b +2, and c +3
seaward_year_vec<-as.numeric(substr(wenatchee.ddl$S$sea_Year_p,2,5))
wenatchee.ddl$S$det_year<-factor(ifelse(wenatchee.ddl$S$Time<2,seaward_year_vec,ifelse(wenatchee.ddl$S$stratum=="A",seaward_year_vec+1,ifelse(wenatchee.ddl$S$stratum=="B",seaward_year_vec+2,seaward_year_vec+3))))


wenatchee.ddl$S$upstream_time<-ifelse(wenatchee.ddl$S$Time>2,1,0)


# fixing S to 1 in strata where fish cant be
wenatchee.ddl$S$fix<-NA
wenatchee.ddl$S$fix[wenatchee.ddl$S$stratum!=1 &
                      wenatchee.ddl$S$Time<=3]=1 #using numeric "Time" which starts at 0 hence 3 is 4





# fit model
p.timexstratum.tag=list(formula=~-1+time)
Psi.sxtime=list(formula=~-1+tostratum)
S.stratumxtime=list(formula=~-1+time+time_1:Yrlng)


test<-RMark::mark(wenatchee.processed,wenatchee.ddl,
                  model.parameters=list(S=S.stratumxtime,p= p.timexstratum.tag,Psi=Psi.sxtime),run=TRUE)

real_test<-get.real(test,par="Phi")
real_test$`Group:LHsmolt.streamChiwawa.sea_Year_py2007`

test$results$beta

sd_rep$value

#compare parameters
sd_rep$par.fixed - test$results$beta[,1]
#compare standard errors
sqrt(diag(sd_rep$cov.fixed)) - test$results$beta[,2]

```
