---
title: Survival and age at maturation of juvenile spring Chinook emigrants from Chiwawa,
  Nason and White River
author: "Mark Sorel"
date: "4/13/2020"
output:
  pdf_document: default
  html_document: default
---
## Paper Title

Demographic differences among juvenile life history strategies  

## Main message

Alternative juvenile life history strategies are associated with different survival and maturation ages at subsequent life stages. 

## Working abstract

Juvenile life history diversity is thought to increase population stability, but the demographic rates of animals exhibiting alternative juvenile life history strategies are rarely understood because it is difficult to track them throughout their life cycles. To understand how survival and maturation rates differ among animals with different juvenile life history strategies, we analyzed a rare long-term mark-recapture data set of Chinook salmon that expressed different juvenile life history strategies with regard to emigration timing from natal stream. Some juveniles emigrated from their natal stream in their first year of life and spent months in downstream rearing habitat prior to migrating to the ocean, while others remained in their natal stream entirely until migrating to the ocean. All fish migrated to the ocean in their second spring of life. Earlier emigrants from the natal stream entered the migration corridor about 20 days earlier on average and migrated somewhat slower and had lower downstream-survival rates than later emigrants in the upper migration corridor. However, earlier emigrants from the natal stream returned from the ocean at higher rates and somewhat younger ages. Overwinter survival of early emigrants downstream of natal areas prior to seaward emigration was found to be negatively correlated with winter air temperature, and as in other recent studies, marine survival was positively correlated to coastal upwelling in spring and negatively correlated with sea surface temperature in summer. Understanding differences in survival and maturation age of animals that exhibit different juvenile life history strategies leads to a more holistic conceptualization of the factors governing population productivity and stability, enabling more mechanistic simulation of the affects of management and climate change on populations.   


## Methods

- Map

### Data

  
Upon emigration from three natal streams - the Chiwawa River, Nason Creek, and the White River - juvenile spring Chinook salmon were sampled with rotary screw traps (Map). The traps were installed in early spring and operated continuously through late fall. From 2006 through 2016, juveniles > 60 mm were implanted with passive integrated transponder (PIT) tags within their peritoneal cavity using a syringe. Each PIT tag had a unique radio-frequency identification (RFID) code that transmitted when triggered by an electromagnetic interrogation pulse from an RFID reader device. 

Fish could be recaptured as juveniles in a rotary screw trap operated near the confluence of the Wenatchee River and the Columbia River, and they could be detected moving through fishways for both juveniles and adults at certain dams within the migration corridor, which were equipped with RFID reader devices. Specifically, we used detections of juveniles at McNary and Bonneville Dams, and detections of Adults at Bonneville, McNary, and Tumwater Dams. Only juveniles that passed via the turbine-bypass pathways had the chance of to be detected, as there were no RFID readers in the spillways or the turbine penstocks. The dates and locations that marked fish were released and subsequently detected at dams were downloaded from the Columbia Basin PIT Tag Information System (data citation).  

```{r, cache=FALSE, echo=FALSE, warning=FALSE, message=FALSE}
options(tinytex.verbose = TRUE)
knitr::opts_chunk$set(echo=FALSE)
library(here)
library(tidyverse)
library(TMB)
library(TMBhelper)
library(glmmTMB)
library(DHARMa)
# library(RMark)
```

Table. Detections by site and year.  
```{r, eval=TRUE, echo=FALSE, message=FALSE, warning=FALSE, cache=FALSE, paged.print=TRUE}
source(here("src","mscjs_wen_helper_funcs.R"))
source(here("src","Wen_MSCJS_re.R"))
# mark_file_CH$rel_DOY_2<-mark_file_CH$`Release Day Number`+ifelse(mark_file_CH$LH=="smolt",365,0)
# hist(mark_file_CH$rel_DOY_2,breaks=seq(0,600,10))
# hist(mark_file_CH$`Length mm`,breaks=seq(0,max(mark_file_CH$`Length mm`,na.rm=TRUE)+5,2.5))
# cor(mark_file_CH$`Length mm`,mark_file_CH$rel_DOY_2,use="complete.obs")
site_year_det<-mark_file_CH %>% filter(LH!="Unk") %>%  select(sea_Year_p,LWe_J:Tum_A) %>%  group_by(sea_Year_p) %>% summarise_all(function(x)sum((x>0))) #%>% print(n=100)
#not using TDD_A or JDD_A currently because of missing years and relatively good detection upstream.
knitr::kable(site_year_det %>%  select(sea_Year_p,LWe_J,McN_J,Bon_J,Bon_A,McN_A,Tum_A) %>% rename(release_year=sea_Year_p) %>% filter(release_year<=2020))
```  

##### Side notes
The first year (2003) is followed by a three year "gap", so I will start the analysis with the 2006 downstream migration year (2004 brood year).  
For whatever reason, when I include John Day Dam juvenile or the estuary towed array in the model, it estimates survival approaching 100% between McNary and John Day and between Bonneville and the Towed Array. I'm therefore excluding John Day and the estuary towed array for now and just modeling survival from McNary to Bonneville. For adults, I'm including Bonneville, McNary and Tumwater only because detection and survival rates are quite high for adults. 

The first time period in the model was between release (juvenile emigration from the natal stream) and passing the screw trap in the lower Wenatchee River en route to the ocean via the Columbia River in fish's second spring. The length of time that this period represented varied from nearly a year for the earliest emigrating juveniles to as little as several days for fish that reared entirely within the natal stream. To account for the heterogeneity in survival rates due to this range of elapsed times, and assess the affect of juvenile emigration timing on subsequent survival and maturation, we divided fish into three juvenile life-history strategies that corresponded with modes of emigration timing from the natal streams as delineated in previous work (Chapter 1). The earliest emigrating juveniles from the natal stream (hereafter summer emigrants), emigrated as subyearlings between day of year 141 and 262. The subsequent group of emigrants (hereafter fall emigrants), emigrated as subyearlings from day of year 263 through when the traps were removed in early winter. The final group of emigrants (hereafter "smolts"), emigrated as yearlings in spring (day of year 53-179), and were delineated from subyearlings based on a previously developed length-date cutoff rule (chapter 1).

\newpage
#### Length and day of at release.
   
Grey shaded area represents all fish captured in screw traps, whereas the red shaded area represents the fish that were PIT tagged. There is a bias toward larger fish being tagged during summer because their is a 60 mm size cutoff for how small of a fish can be tagged. We could address this by including release length as a covariate and use that relationship to account for the expected survival of the untagged component of the population. I think this might be better left out of this paper and included in the population-model paper though.  

  
*Day of year at release*  
```{r examine_tag_distribution,message=FALSE, warning=FALSE,eval=TRUE,fig.height=5, fig.width=5}
ggplot(all_bio_data,aes(x=DOY))+geom_density(alpha=.5,fill="black",color=NA)+facet_wrap(~LH,scales = "free_y")+geom_density(data=mark_file_CH %>% filter(LH!="Unk"),aes(x=`Release.Day.Number`), alpha=.5,fill="red",color=NA)
```  
\newpage
*Length at release*
```{r examine_tag_distribution2,message=FALSE, warning=FALSE,eval=TRUE,fig.height=5, fig.width=5}
ggplot(all_bio_data,aes(x=Length))+geom_density(alpha=.5,fill="black",color=NA)+facet_wrap(~LH,scales = "free_y",nrow = 2)+geom_density(data=mark_file_CH %>% filter(LH!="Unk"),aes(x= `Length.mm`), alpha=.5,fill="red",color=NA)+xlim(30,130)
```



\newpage

#### Timing of different life histories at dams.   
    
All years and streams are combined in these plots. Subyearling emigrants from natal stream have very similar timing to each other. Earlier emigrants from natal stream are somewhat earlier (~20 days) and slower moving (~10 days) through the upper Columbia than smolt emigrants.  

```{r timing, fig.height=6.5, fig.width=6.5, message=FALSE, warning=FALSE}

dat<-mark_file_CH %>% filter(LH!="Unk") %>%pivot_longer(c(LWe_J_doy,McN_J_doy,Bon_J_doy) ) %>% group_by(LH,name) %>%mutate(med.doy=median(value,na.rm=T)) %>% mutate(LH=as.factor(LH),LH=fct_relevel(LH,"summer","fall","smolt"),name=case_when(name=="LWe_J_doy"~"Lower Wenatchee",name=="McN_J_doy"~"McNary",TRUE~"Bonneville"),name=as.factor(name),name=fct_relevel(name,"Lower Wenatchee","McNary","Bonneville")) %>% ungroup()

ggplot(dat=dat , aes(x=value)) +geom_histogram(fill="grey",binwidth=10)+geom_vline(dat=dat , aes(xintercept=med.doy))+
  facet_grid(LH~name,scales="free")+xlab("Day of year")+xlim(25,200)

```



\newpage

### Model
  
We used a multistate Cormack-Jolly-Seber model to estimate the probability of survival $\phi^t_{l,a,y,s}$ during interval $t$ for fish that expressed juvenile life history $l$ from stream $a$ in year $y$ and, for upstream migrating adults, age $s$. Within the model we also estimated probabilities $\boldsymbol \psi_{l,y}$ of fish spending 1, 2 or 3 years at sea conditional on surviving to return from the ocean. 
  
#### Survival -

Survival probabilities were modeled in logit space as,
$$logit(\phi^t_{l,a,y,s})=\alpha^t + {\mathbf{x}^{t'}_{l,a,y,s}} \boldsymbol \beta ^t + \delta^t_{y}$$

where $\alpha^t$ was an interval-specific intercept, $\mathbf{x}^t_{l,a,y,s}$ was a row of the design matrix, $\boldsymbol \beta^t$ was a vector of coefficients, and $\delta^t_{y}$ were synchronous random year effects applied to all juvenile life histories and streams, $\delta^t_{y} \sim N(0,\sigma^2_{\delta^t})$. To increase the precision of estimates and improve the predictive ability of the model, we applied penalized-complexity priors (Simpson et al. 2017) on coefficients $\boldsymbol\beta^t$, treating them as Gaussian random effects where the standard deviation of the hyper-distribution was exponentially distributed,  

$$
\begin{split}
\boldsymbol \beta^t \sim N(\mathbf 0,\Sigma_{\beta^t})\\
\Sigma_{\beta^t} = diag(\boldsymbol \sigma^2_{\beta^t})\\
\boldsymbol \sigma_{\beta_t} \sim exp(\lambda)
\end{split}
$$

and $\lambda$ determined the strength of the penalty. We selected $\lambda$ = 7, which resulted in a marginal prior standard deviation of approximately `r round((-log(0.01)/7)*.31,2)` and a prior probability of 1% of a coefficient being greater than or equal to `r round(-log(0.01)/7,2)`. 

During the first survival interval we allowed each juvenile life history its own intercept (i.e., $\alpha^t_l$) because each life history spent different amounts of time in this interval and were therefore expected to have different survival rates. In subsequent occasions we treated the intermediate life history (fall emigrants) as the intercept $\alpha^t$ and penalized coefficients for the summer- and smolt-emigrant life histories. During the first interval we included penalized effects of natal stream and stream x life-history interactions because fish from different streams migrate through somewhat different habitats. In particular, fish from the White River transit Lake Wenatchee, whereas fish from Nason and Chiwawa do not. Stream was contrast-coded in the design matrix, so that we penalized deviations from the mean for all stream. In subsequent occasions, we did not allow for survival differences among natal stream, because the model did not always estimate reasonable survival rates when stream differences were included. For intervals representing upstream migration of adults we included penalized effects of age, treating the intermediate age 4 as the intercept. No effects of either juvenile life history or natal stream were included for adult upstream survival.

  
We included several environmental covariates on survival probabilities. Average annual winter (November-February) air temperature and stream discharge were included for survival of life histories that emigrated from their natal stream as subyearlings (summer and fall emigrants), assuming common effects across life histories and streams. We included effects of average water temperature and discharge at Rock Island Dam in April-May and McNary dam in May-June on survival during the second and third intervals respectively, again assuming common effects across juvenile life histories and streams. Average spill percentage at Rock Island, Priest Rapids, and Wannapum Dams in April-May was included for survival in the second interval, and average spill percentage at McNary, John Day, and the Dalles Dams in May-June was included for survival in the third interval. Based on the findings of Crozier et al. (2021), we included the following covariates on marine survival: sea surface temperature in the northeast Pacific Ocean during the winter prior to when smolts enter the marine environment, a coastal upwelling index measured during the spring, and sea surface temperature off the coast of Washington State during the summer after smolts enter the ocean.  

#### Maturation ages -
The conditional probabilities $\boldsymbol \psi_{l,y}$ of returning at ages 3, 4, or 5 given that a fish survived were modeled using a multinomial logit link, 

$$
\begin{split}
mlogit(\boldsymbol \psi_{l,y}) = \boldsymbol \alpha^\psi +  \boldsymbol \beta_l ^\psi +  \boldsymbol \delta^\psi_y\\
\boldsymbol \beta^{\psi}_l \sim N(\mathbf 0,\Sigma_{\beta^\psi_l})\\
\Sigma_{\beta_l^\psi} = diag(\boldsymbol \sigma^2_{\beta^\psi_l})\\
\boldsymbol\sigma^2_{\beta^\psi_l} \sim exp(\lambda) \\
\boldsymbol \delta^\psi_y \sim N(0,\Sigma_{\delta^\psi})
\end{split}
$$

with age 4 as the reference year, $\boldsymbol \alpha^\psi$ represented the intercepts for ages 3 and 5 for the fall-emigrant juvenile life history, $\boldsymbol \beta_l^\psi$ were penalized coefficients for the summer and smolt juvenile life-history strategies at ages 3 and 5, and $\boldsymbol \delta^\psi_y$ were random year effects for ages 3 and 5 applied to all juvenile life histories. The random year effects were bivariate normally distributed with covariance matrix $\Sigma_{\delta^\psi}$, which accounted for inherent correlation in the proportions of the population that matured as 3 and 5 year olds.  We chose to model conditional maturation probabilities separately from marginal survival probabilities so that we could easily model the effects of environmental covariates measured during the critical early marine period on marginal survival probabilities. 



#### Detection -
Detection probabilities were modeled with the same formulation as survival probabilities, with the exception that the detection probability at the final occasion was set to 1.0. Specifically, we allowed for un-penalized life-history specific intercepts and penalized stream x life-history interactions on detection following the first interval, but did not include stream effects on subsequent detection occasions nor life-history effects on upstream adult detection occasions. Age effects were included for upstream migrating adult detection. The assumption of perfect detection at the final occasion was supported by auxiliary observations that `r sum(mark_file_CH$instr_array!=0&mark_file_CH$Tum_A!=0,na.rm=TRUE)` out of `r sum(mark_file_CH$instr_array!=0,na.rm=TRUE)` fish detected in adult fish ladders in mainstem Columbia River Dams and subsequently detected on in-stream arrays in the Wenatchee River Basin upstream of Tumwater Dam were also detected at Tumwater Dam between those detections. We included average discharge and spill percentage at McNary and Bonneville Dam in May-June on detection probabilities at those dams, but no other environmental covariates on detection probabilities.

##### side note
It would be cool to extend this model to the instream arrays in the tributaries for adult detections someday. I think sample sized are too small to learn anything about straying with this data set, but it could have other advantages or come in handy with other data sets. 


### Likelihood
A multistate Cormack-Jolly-Seber model is a hidden Markov model and the likelihood of a given capture history $x$ at occasions 1 through $T$ can be calculated using the forward algorithm,
$$\mathcal{L}\left(\theta\mid x_1,\ldots,x_T\right)=\delta\Gamma P\left(x_2\right)\cdots\Gamma P\left(x_{T-1}\right)\Gamma P\left(x_T\right)\mathbf{1}$$
where $\theta$ is a vector of model parameters, $\delta$ is the initial-distribution vector of state probabilities at release, $\Gamma$ are state-transition probability matrices specifying the probability of transitioning from each state at time $t$ to each state at time $t + 1$, ${P}$ are state-dependent distributions that are diagonal matrices of conditional probabilities of observations given a fish is in each state, and $\mathbf{1}$ is a column vector of ones that sums the probabilities across states after the final occasion (See Zucchini et al. 2016 or McClintock et al. 2020 for details on the forward algorithm for hidden Markov models). Conditioning on release, the initial probability vector had a probability of 1.0 that fish were alive at release. The transition matrix $\Gamma$ for all intervals other than the marine-residence interval was,  
$$\begin{array}{rccc}&  Alive   & Dead \\Alive & \phi^t_{l,a,y,s} &  1-\phi^t_{l,a,y,s} \\Dead & 0 &1 \\ \end{array}$$

whereas the transition matrix for the marine-residence interval was   

$$\begin{array}{rccccc}
& 3~year~old & 4~year~old  & 5~year~old & dead \\
Alive &  \phi^t_{l,y}(\psi_{l,y,3}) & \phi^t_{l,y}(\psi_{l,y,4}) & \phi^t_{l,y}(\psi_{l,y,5}) & 1-\phi_{i,t,y} \\
Dead & 0 & 0 &  0 & 1 \\ 
\end{array}$$

Once fish returned from the ocean, they could either remain in their current state or die, so the 2 x 2 transition matrix could be used again. The observation matrix was,

 $$\begin{array}{rccc}&  Detected   & Not~ detected \\Alive &  p^t_{l,a,y,s} &  1-p^t_{l,a,y,s} \\Dead & 0 &1 \\\end{array}$$
so the state dependent distributions $P$ used in the forward algorithem are diagonal matrices with the column of the observation matrix corresponding with the observed data value along the diagonal.


## Model fitting
  
The model was fit by maximizing the log-likelihood function with respect to parameters. The Laplace approximation of the marginal log-likelihood integrated over random effects was calculated by the package TMB (Kristensen et al 2016) for a given set of fixed effects values, and optimization of the fixed effects was conducted in the R statistical program using the TMBhelper package (Thorson).The standard errors of fixed and random parameters, as well as derived quantities, were calculated by TMB using a generalization of the delta method. Fixed-effect parameters included the intercepts $\boldsymbol \alpha$ for $\boldsymbol \phi, \mathbf p$ and $\boldsymbol \psi$ at each occasion as well as the variance and covariance parameters for the hypder-distributions of the Gaussian random effects, penalized coefficients $\boldsymbol \beta$ and random year effects$\boldsymbol \delta$. 


#### Goodness of fit -
We assessed goodness of fit by examining scaled quantile residuals. We simulated 250 data sets of the same size as the observed data by sampling from binomial distributions for survival and detection, and multinomial distributions for maturation age. Simulations were conducted using the fitted model parameters and either the fitted random year effects or by drawing random year effects from their hyper-distributions. We summarized the simulated and observed data by the number of recaptures/detections from each release cohort (life history x stream x year) and age at each occasion, and used the DHARMa package (Hartig 2021) to generate scaled quantile residuals and to interrogate them for violations of model assumptions.


\newpage


```{r , message=FALSE, warning=FALSE, process_dat,echo=FALSE,cache=FALSE}
mscjs_dat<- make_dat(mark_file_CH,sites=c( "LWe_J",
  "McN_J",
  #"JDD_J",
   "Bon_J",
   #"Est_J",
  "Bon_A","McN_A",
  #"PRa_A","RIs_A",
  "Tum_A"),cont_cov=c(),length_bin = 5,doy_bin = 10,inc_unk = FALSE,exc_unk=TRUE) #,"rel_DOY_bin","length_bin"

rm(mark_file)
rm(all_bio_data)
```



```{r loo_ic, message=FALSE, warning=FALSE,echo=FALSE,eval=FALSE}
#penalized complexity

Loo_pen2<-list()
AIC_vec<-numeric(20)
for ( i in 11:15){

mscjs_fit<-fit_wen_mscjs(x=mscjs_dat,
                         #survival
                         phi_formula=par.index~
                           
                            ## to Bonneville
                            -1+ time1:LH + time1:stream+ time1:C(LH, base = 1):stream+
                            # pc(0+time1:rel_DOY_bin:age_0|one)+
                            # time1:sum_flow:LHsummer+time1:sum_air:LHsummer +
                            time1:win_air:age_0 +time1:win_flow:age_0+
                            # pc(0+time1:spr_dis+time1:spr_air|one) +
                             
                            diag(0+time1|mig_year) +
                        pc(0+time1:LH|mig_year)+
                           
                            ## to McNary
                             time2+time2:C(LH, base = 1)+
                              time2:RIS_flow_juv+time2:RIS_temp_juv+time2:UC_spill_pct_juv +
                            diag(0+time2 |mig_year)+
                           pc(0+time2:LH|mig_year)+
                           
                            ##to Bonneville
                            time3 + time3:C(LH, base = 1)+
                             diag(0+time3|mig_year)+
                            pc(0+time3:LH|mig_year)+
                             time3:McN_flow+ time3:McN_temp+time3:MC_spill_pct_juv+
                           
                            ## SAR to Bonneville adult
                            time4 + time4:C(LH, base = 1) +
                           diag(0+time4 |mig_year)+ 
                            pc(0+time4:LH|mig_year)+
                            time4:ersstWAcoast.sum +time4:ersstArc.win+
                           time4:cui.spr +
                            ## to McNary Adult
                            time5 + time5:C(stratum, base = 2) + diag(0+time5|mig_year)+  
                           
                            ## to Tumwater Adults
                            time6 + time6:C(stratum, base = 2)+ diag(0+time6|mig_year) 
                            ,
                           
                         #detection
                            p_formula= par.index~
                           
                            ## Lower Wenatchee Trap
                            -1+ time2:LH+ time2:stream  + time2:C(LH, base = 1):stream+
                           diag(0+time2|mig_year)+
                           pc(0+time2:LH|mig_year) +#time2:LWe_new+
                            
                           ## McNary Juveniles
                            time3 + time3:C(LH, base = 1)+ 
                           time3:McN_flow +time3:McN_spill+
                            diag(0+time3|mig_year)+
                           pc(0+time3:LH|mig_year) +
                            # time3:LWe_J:age_class+
                           # Bonneville Juvenile
                            time4 +time4:C(LH, base = 1)+ 
                           time4:Bon_flow+time4:Bon_spill+
                            # time4:McN_J+
                           diag(0+time4|mig_year)+
                           pc(0+time4:LH|mig_year) +
                             
                            
                           # Bonn adult
                            time5 +time5:C(stratum, base = 2) + diag(0+time5 |mig_year)+ 
                            
                           #McNary adult
                            time6 + time6:C(stratum, base = 2)+ diag(0+time6 |mig_year) 
                         ,
                          #maturation age                        
                            psi_formula= par.index~
                            -1+tostratum + tostratum:C(LH, base = 1)+
                           # tostratum:streamChiwawa +
                           # tostratum:streamWhite+
                            (0+tostratum|mig_year)#+pc(0+tostratum:LH|mig_year)
                           ,
                           
    
                            doFit = TRUE,silent=TRUE,
                            sim_rand =0,REML=FALSE,pen=i, hypersd=1,map_hypers=c(FALSE,FALSE))
                         # start_par=mscjs_fit$mod$env$parList(par=last_best))


#calculate LOOIC for model
last_best<-mscjs_fit$mod$env$last.par.best
sim_posterior<-rmvnorm_prec(mu=mscjs_fit$mod$env$last.par.best, 
                            prec=mscjs_fit$fit$SD$jointPrecision, 500, random_seed=1 )

x_mat<-matrix(NA,ncol=sum(mscjs_fit$dat_TMB$freq),nrow=500)
for ( j in 1:500){
  
 rep<-mscjs_fit$mod$report(par=sim_posterior[,j]) 
 
x_mat[j,]<-rep(rep$NLL_it_vec, times = mscjs_fit$dat_TMB$freq) 
  
}

loo_out<-loo::loo(x_mat,cores=8)

#save LOOIC in list
Loo_pen2[[i-1]]<-loo_out
AIC_vec[i]<-mscjs_fit$fit$AIC
print(i)
}


# save list of all LOOICs
 # save(Loo_pen2,file=here("Loo_pen10.Rdata"))
#Loo_pen5.Rdata = age_class interceptsa and year random effects
#Loo_pen6.Rdata = age_class intercepts
#Loo_pen7.Rdata = LH intercepts 
#Loo_pen8.Rdata = LH intercepts year and random effects 
#Loo_pen9.Rdata = LH intercepts year and random effects (summer and smolt) 
#Loo_pen10.Rdata = LH intercepts year and no-pen random effects (summer and smolt) 
 
 
# dev.new()
# plot_func()
# print_out(mscjs_fit)
# 
# save(mscjs_fit,file = here("mscjs_fit.Rdata"))
# 
# mscjs_fit$dat_TMB$X_phi %>% as_tibble()
# 
# mscjs_fit$Phi.design.glmmTMB$data.tmb$terms$`0 + time1 | stream:LH`
# dev.new()
# print_out(mscjs_fit)
# plot_func()
# 
# test<-mscjs_fit$mod$report()
# test$p_yrlngs %>% `names<-`(c(2006:2010,2013:2017)) %>% round(2)


```




```{r plot_looic, message=FALSE, warning=FALSE,echo=FALSE,eval=FALSE}
load(file=here("Loo_pen7.Rdata"))
Looic<-unlist(lapply(Loo_pen2,function(x){x$estimates[3,1]}))
plot(which(!unlist(lapply(Loo_pen2,is.null)))+1,Looic,xlab=expression(lambda),ylab="LOOIC",pch=19)
```







```{r null_model ,message=FALSE, warning=FALSE,eval=FALSE,cache=FALSE}
# "null" model
mscjs_fit<-fit_wen_mscjs(x=mscjs_dat,
                         phi_formula=par.index~
                           
                           #fixed effect
                           -1+ time1:LH+time1:streamWhite:LH+ +time2+time2:age_class+time3 +time4:LH+time4 +time5+time6,
                      
                         p_formula= par.index~
                           #fixed effects
                           -1+ time2:LH+time3+time3:age_class+time4+time4:age_class+  +time5  +time6, 
                         
                         psi_formula= par.index~
                           #fixed effects
                           -1+tostratum+tostratum:age_class,
                         
                         doFit = TRUE,silent=TRUE,sim_rand = 10,pen=1,hypersd=1,map_hypers=c(FALSE,FALSE)
)

dev.new()
print_out(mscjs_fit)
plot_func()

mscjs_fit$dat_TMB$X_phi %>% dimnames()

```



```{r full_model1, message=FALSE, warning=FALSE,echo=FALSE,eval=FALSE}
# #penalized complexity
# mscjs_fit<-fit_wen_mscjs(x=mscjs_dat,
#                          #survival
#                          phi_formula=par.index~
#                            
#                             ## to Bonneville
#                             -1+  time1:LH_t1 +pc(0+time1|stream_t1 ) +  pc(0+time1:stream_t1|LH_t1 ) +#+pc(0+time1|age_class)
#                             # pc(0+time1:rel_DOY_bin:age_0|one)+
#                             # pc(0+tizme1:sum_flow:LHsummer+time1:sum_air:LHsummer|one) +
#                             time1:win_air:age_0 + time1:win_flow:age_0+
#                             # pc(0+time1:spr_dis+time1:spr_air|one) +
#                              pc(0+time1|mig_year)+  pc(0+time1:LH|mig_year)+ #diag(0+time1:age_class |mig_year) +
#                            
#                             ## to McNary
#                             time2+ pc(0+time2|age_class) + pc(0+time2|LH) +   #pc(0+time2:LHsummer|one)+
#                             
#                             pc(0+time2:LH |mig_year)+ pc(0+time2 |mig_year)+  #(0+time2:age_class |mig_year)+
#                            time2:RIS_flow_juv+time2:RIS_temp_juv+time2:UC_spill_pct_juv+
#                            
#                             ##to Bonneville
#                             time3 + pc(0+time3|age_class) + pc(0+time3|LH) + # pc(0+time3:LHsummer|one) +
#                             pc(0+time3 |mig_year)+ pc(0+time3:LH|mig_year)+
#                             time3:McN_flow+time3:McN_temp+time3:MC_spill_pct_juv+
#                            
#                             ## SAR to Bonneville adult
#                             time4 + pc(0+time4|age_class) + pc(0+time4|LH) +  # 
#                            pc(0+time4:LH |mig_year)+pc(0+time4 |mig_year)+ #diag(0+time4|mig_year)+ 
#                             time4:ersstWAcoast.sum+time4:ersstArc.win+
#                             ## to McNary Adult
#                             time5 + pc(0+time5|mig_year)+ # pc(0+time5|stratum ) +                  
#                            
#                             ## to Tumwater Adults
#                             time6  +pc(0+time6|mig_year) #+ pc(0+time6|LH )+ 
#                             ,
#                            
#                          #survival
#                             p_formula= par.index~
#                            
#                             ## Lower Wenatchee Trap
#                             -1+ time2:LH_t1 + pc(0+time2|stream_t1 ) + pc(0+time2:stream_t1|LH_t1 ) +  
#                            pc(0+time2:LH|mig_year) +#time2:LWe_new+
#                             
#                            ## McNary Juveniles
#                             time3 + pc(0+time3|LH) +
#                             pc(0+time3:LH |mig_year)+ 
#                             time3:LWe_J:LH +
#                            
#                            # Bonneville Juvenile
#                             time4 + pc(0+time4|LH) +  
#                             pc(0+time4:LH |mig_year) + 
#                              time4:McN_J:LH +
#                             
#                            # Bonn adult
#                             time5 + pc(0+time5|mig_year ) +#pc(0+time5 |stratum)+ #
#                             
#                            #McNary adult
#                             time6+ pc(0+time6|mig_year )  #+pc(0+time6 |stratum)## +
#                          ,
#                           #maturation age                        
#                             psi_formula= par.index~
#                             -1+tostratum + pc(0+tostratum|LH) + pc(0+tostratum|stream)  +
#                             (0+tostratum|mig_year)
#                            ,
#                            
#     
#                             doFit = TRUE, silent=TRUE, 
#                             sim_rand =0, REML=FALSE, pen=3, hypersd=1, map_hypers=c(FALSE,FALSE)
# )
# 
# print_out(mscjs_fit)
# dev.new()
# plot_func()
# View(mscjs_fit$dat_TMB$Z_phi)
```



## Preliminary Results (diagnostic, not paper tables and figures)
#### Key for model parameters  
Everything modeled on logit scale, but see plots below for estimates of annual survival and maturation age probabilities.  


**time  1 ($\phi$) or time 2 ($p$) LH intercepts**  
*LH_fall*     =    fall-emigrant life history  
*LH_smolt*     =   smolt-emigrant life history  
*LH_summer*     =  summer-emigrant life history  

**dummy-variable coded LHs**  
*C(LH, base = 1)2* = smolt-emigrant life history  
*C(LH, base = 1)3* =  summer-emigrant life history  

**deviation-contrast coded time 1 ($\phi$) or time 2 ($p$) streams**  
*stream1*    =    Chiwawa River  
*stream2*     =   Nason Creek 

**dummy-variable coded adult ages**  
*C(stratum, base = 2)1* = age 3
*C(stratum, base = 2)3* = age 5

$\boldsymbol \phi$ **(survival)**  
*time1* = release to lower Wenatchee trap  
*time2* = lower wenatchee to McNary  
*time3* = McNary to Bonneville  
*time4* = smolt to adult Bonneville to Bonneville  
*time5* = upstream Bonneville to McNary  
*time6* = upstream McNary to Tumwater  

*win_air* = winter air temperature  
*win_flow* = winter dishcharge in the Wenatchee River
*age_0* = combined fall- and summer-emigrants life histories 

*RIS_temp_juv*  = spring upper Columbia temp  
*RIS_flow_juv* = spring upper Columbia flow
*UC_spill_pct_juv* = spring upper Columbia spill percentage

*McN_temp* = spring middle Columbia temp
*McN_flow* = spring middle Columbia flow
*MC_spill_pct_juv* = spring middle Columbia spill percentage

*ersstWAcoast.sum* = summer sea surface temperature off Washington coast  
*ersstArc.win* = winter (before smolts enter) sea surface temperature in area defined by Johnstone and Mantua (2014)  
*cui.spr* = spring coastal upwelling index    

$\mathbf p$ **(detection probability)**  
*time2* = Lower Wenatchee trap  
*time3* = McNary Juvenile  
*time4* = Bonneville Juvenile  
*time5* = Bonneville Adult  
*time6* = McNary Adult  
*time7* = Tumwater adult detection assumed 100%  

*McN_flow* = McNary Dam spring flow
*McN_spill* = McNary Dam spring spill percentage

*Bon_flow* = Bonneville Dam spring flow
*Bon_spill* = Bonneville Dam spring spill percentage
  
$\boldsymbol \psi$ **(maturation age probability)**  
*tostratum2* = return as Jack (3 year-old, one year at sea)  
*tostratum3* = return as 5-yo (three years at sea)  


\newpage

#### Fitted parameter values

\ 

```{r full_model2, message=FALSE, warning=FALSE,echo=FALSE,eval=TRUE,cache=FALSE}
#penalized complexity

mscjs_fit<-fit_wen_mscjs(x=mscjs_dat,
                         #survival
                         phi_formula=par.index~
                           
                            ## to Bonneville
                            -1+ time1:LH + time1:stream+ time1:C(LH, base = 1):stream+
                            # pc(0+time1:rel_DOY_bin:age_0|one)+
                            # time1:sum_flow:LHsummer+time1:sum_air:LHsummer +
                            time1:win_air:age_0 +time1:win_flow:age_0+
                            # pc(0+time1:spr_dis+time1:spr_air|one) +
                             
                            diag(0+time1|mig_year) +
                        # pc(0+time1:LH|mig_year)+
                           
                            ## to McNary
                             time2+time2:C(LH, base = 1)+
                              time2:RIS_flow_juv+time2:RIS_temp_juv+time2:UC_spill_pct_juv +
                            diag(0+time2 |mig_year)+
                           # pc(0+time2:age_class|mig_year)+
                           
                            ##to Bonneville
                            time3 + time3:C(LH, base = 1)+
                             diag(0+time3|mig_year)+
                            pc(0+time3:LH|mig_year)+
                             time3:McN_flow+ time3:McN_temp+time3:MC_spill_pct_juv+
                           
                            ## SAR to Bonneville adult
                            time4 + time4:C(LH, base = 1) +
                           diag(0+time4 |mig_year)+ 
                            pc(0+time4:LH|mig_year)+
                            time4:ersstWAcoast.sum +time4:ersstArc.win+
                           time4:cui.spr +
                            ## to McNary Adult
                            time5 + time5:C(stratum, base = 2) + diag(0+time5|mig_year)+  
                           
                            ## to Tumwater Adults
                            time6 + time6:C(stratum, base = 2)+ diag(0+time6|mig_year) 
                            ,
                           
                         #detection
                            p_formula= par.index~
                           
                            ## Lower Wenatchee Trap
                            -1+ time2:LH+ time2:stream  + time2:C(LH, base = 1):stream+
                           diag(0+time2|mig_year)+
                           # pc(0+time2:LH|mig_year) +#time2:LWe_new+
                            
                           ## McNary Juveniles
                            time3 + time3:C(LH, base = 1)+ 
                           time3:McN_flow +time3:McN_spill+
                            diag(0+time3|mig_year)+
                           # pc(0+time3:age_class|mig_year) +
                            # time3:LWe_J:age_class+
                           # Bonneville Juvenile
                            time4 +time4:C(LH, base = 1)+ 
                           time4:Bon_flow+time4:Bon_spill+
                            # time4:McN_J+
                           diag(0+time4|mig_year)+
                           # pc(0+time4:age_class|mig_year) +
                             
                            
                           # Bonn adult
                            time5 +time5:C(stratum, base = 2) + diag(0+time5 |mig_year)+ 
                            
                           #McNary adult
                            time6 + time6:C(stratum, base = 2)+ diag(0+time6 |mig_year) 
                         ,
                          #maturation age                        
                            psi_formula= par.index~
                            -1+tostratum + tostratum:C(LH, base = 1)+
                           # tostratum:streamChiwawa +
                           # tostratum:streamWhite+
                            (0+tostratum|mig_year)#+pc(0+tostratum:LH|mig_year)
                           ,
                           
    
                            doFit = TRUE,silent=TRUE,
                            sim_rand =0,REML=FALSE,pen=7, hypersd=1,map_hypers=c(FALSE,FALSE))
                         # start_par=mscjs_fit$mod$env$parList(par=last_best))


# dev.new()
# plot_func()
print_out(mscjs_fit)
# 
# save(mscjs_fit,file = here("mscjs_fit.Rdata"))
# 
# mscjs_fit$dat_TMB$X_phi %>% as_tibble()
# 
# mscjs_fit$Phi.design.glmmTMB$data.tmb$terms$`0 + time1 | stream:LH`
# dev.new()
# print_out(mscjs_fit)
# plot_func()
# 
# test<-mscjs_fit$mod$report()
# test$p_yrlngs %>% `names<-`(c(2006:2010,2013:2017)) %>% round(2)


```


\newpage

### Survival and maturation probabilities  


```{r plot_output, fig.height=7, fig.width=8, message=FALSE, warning=FALSE,eval=TRUE}  
library(viridis)
sd_rep<-mscjs_fit$fit$SD
mod_rep<-mscjs_fit$mod$report()

Phi.design.dat2 <- mscjs_dat$Phi.design.dat%>% mutate(
                                            eta_phi= sd_rep$value[names(sd_rep$value)=="eta_phi"],
                                            eta_phi_sd=sd_rep$sd[names(sd_rep$value)=="eta_phi"],
                                            phi_fit=plogis(eta_phi),
                                            lcl_phi=plogis(qnorm(.025,eta_phi,eta_phi_sd)),
                                            ucl_phi=plogis(qnorm(.975,eta_phi,eta_phi_sd))) %>% 
  mutate(LH=fct_relevel(LH,"summer","fall","smolt")) %>%
  group_by(LH,mig_year,stream,time) %>%
  mutate(cohort_freq=sum(freq)) %>% 
  mutate(across(phi_fit:ucl_phi,~sum(.*freq/cohort_freq))) %>% 
  filter(!(time=="1"&LH=="Unk"))#%>% 
  # summarize(sum(length_bin*freq/cohort_freq))

# Phi.design.dat2<-Phi.design.dat2 %>% select(time ,stratum , LH , stream ,mig_year, phi_fit)

p.design.dat <- mscjs_dat$p.design.dat %>% mutate(#p_fit=mod_rep$p[-length(mod_rep$p)],
                                            eta_p=sd_rep$value[names(sd_rep$value)=="eta_p"],
                                            eta_p_sd=sd_rep$sd[names(sd_rep$value)=="eta_p"],
                                             p_fit=plogis(eta_p),
                                            lcl_p=plogis(qnorm(.025,eta_p,eta_p_sd)),
                                            ucl_p=plogis(qnorm(.975,eta_p,eta_p_sd)))%>% 
  filter(!(time=="1"&LH=="Unk"))


Psi.design.dat<-mscjs_dat$Psi.design.dat %>% filter(tostratum==2) %>% select(LH,mig_year,) %>% cbind(mod_rep$psi) %>% #filter(LH!="summer",McN_J==0,stream!="LWE") %>%
  pivot_longer(`1`:`3`,names_to="years",values_to="prop") %>% distinct() %>%  mutate(LH=fct_relevel(LH,"summer","fall","smolt"))#%>% mutate(LH=ifelse(LH=="fall","Subyearling","Smolt")) 

#Wenatchee winter survival
# dev.new()

ggplot(data= as_tibble(Phi.design.dat2) %>% filter(Time==0),aes(x=(mig_year) ,y=phi_fit,color=stream)) +scale_x_discrete(guide = guide_axis(check.overlap = TRUE))+geom_linerange(aes(ymin=lcl_phi,ymax=ucl_phi),position=position_dodge(width = .75))+facet_grid(rows=vars(time),cols=vars(LH),labeller =  labeller(time=c(`1`="Release to Lower Wenatchee",`2`="Lower Wenatchee to McNary", `3` = "McNary to Bonneville ")),scales = "free")+ylim(0,1)+xlab("Smolt year")+ylab("Survival") + geom_point(position=position_dodge(width = .75))+ scale_color_viridis(option="B",discrete=T,end=.7)

```

\

```{r plot_output2, fig.height=7, fig.width=8, message=FALSE, warning=FALSE,eval=TRUE}  
#to McNary
ggplot(data= as_tibble(Phi.design.dat2) %>% filter(Time==1),aes(x=(mig_year) ,y=phi_fit)) +scale_x_discrete(guide = guide_axis(check.overlap = TRUE))+geom_linerange(aes(ymin=lcl_phi,ymax=ucl_phi),position=position_dodge(width = .75))+facet_grid(rows=vars(time),cols=vars(LH),labeller =  labeller(time=c(`1`="Release to Lower Wenatchee",`2`="Lower Wenatchee to McNary", `3` = "McNary to Bonneville ")),scales = "free")+ylim(0,1)+xlab("Smolt year")+ylab("Survival") + geom_point(position=position_dodge(width = .75))
```

\
```{r plot_output3, fig.height=7, fig.width=8, message=FALSE, warning=FALSE,eval=TRUE}  
#to Bonneville
ggplot(data= as_tibble(Phi.design.dat2) %>% filter(Time==2),aes(x=(mig_year) ,y=phi_fit)) +scale_x_discrete(guide = guide_axis(check.overlap = TRUE))+geom_linerange(aes(ymin=lcl_phi,ymax=ucl_phi),position=position_dodge(width = .75))+facet_grid(rows=vars(time),cols=vars(LH),labeller =  labeller(time=c(`1`="Release to Lower Wenatchee",`2`="Lower Wenatchee to McNary", `3` = "McNary to Bonneville ")),scales = "free")+ylim(0,1)+xlab("Smolt year")+ylab("Survival") + geom_point(position=position_dodge(width = .75))
```

\
```{r plot_output4, fig.height=7, fig.width=8, message=FALSE, warning=FALSE,eval=TRUE}  
#ocean
ggplot(data= as_tibble(Phi.design.dat2) %>% filter(Time==3),aes(x=(mig_year) ,y=phi_fit)) + geom_point(position=position_dodge(width = .75))+geom_linerange(aes(ymin=lcl_phi,ymax=ucl_phi),position=position_dodge(width = .75))+facet_grid(rows=vars(time),cols=vars(LH),labeller =  labeller(time=c(`4`="Bonneville to Bonneville (adult)")),scales = "free") + xlab("Smolt year")+ylab("Survival")+ geom_point(position=position_dodge(width = .75))+scale_x_discrete(guide = guide_axis(check.overlap = TRUE))

# return age proportions
# dev.new()
ggplot(data= as_tibble(Psi.design.dat), aes(fill=years ,x = mig_year, y =prop)) + geom_bar(stat="identity", width=1)+labs(color = "Sea \nyears") + ylab("Proportion")+xlab("Smolt year") +facet_grid(~ LH)+ scale_x_discrete(guide = guide_axis(check.overlap = TRUE))+ scale_fill_viridis(option="D",discrete=T,end=.7)

#upstream survival
# dev.new()
ggplot(data= as_tibble(Phi.design.dat2) %>% filter(Time>3),aes(x=(mig_year) ,y=phi_fit,color=stratum)) + geom_point(position=position_dodge(width = .75))+labs(color = "Sea years")+geom_linerange(aes(ymin=lcl_phi,ymax=ucl_phi),position=position_dodge(width = .75)) + facet_grid(rows=vars(time),cols=vars(LH),labeller =  labeller(time=c(`5`="Bonneville to McNary",`6`="McNary to Tumwater ")),scales = "free")+ylim(0,1)+xlab("Return year")+ylab("Survival")+ geom_point(position=position_dodge(width = .75)) + scale_x_discrete(guide = guide_axis(check.overlap = TRUE))+ scale_color_viridis(option="D",discrete=T,end=.7)

```  

\newpage
### Detection probabilities  

```{r plot_detection, fig.height=7, fig.width=8, paged.print=TRUE,eval=TRUE}  
#detection probability
#time 2 (LH x stream x year)
# dev.new()

ggplot(data= as_tibble(p.design.dat) %>% filter(Time==0),aes(x=mig_year ,y=p_fit,color=LH)) + geom_point(position=position_dodge(width = .5))+geom_linerange(aes(ymin=lcl_p,ymax=ucl_p),position=position_dodge(width = .5))+facet_grid(time~stream,scales="free",labeller =  labeller(time=c(`2`="Lower Wenatchee",`3`="McNary")))+xlab("Smolt year")+ylab("Detection")+ scale_color_viridis(discrete=T,end=.7)+scale_x_discrete(guide = guide_axis(check.overlap = TRUE))
```
\

```{r plot_detection2, fig.height=7, fig.width=8, paged.print=TRUE,eval=TRUE} 
ggplot(data= as_tibble(p.design.dat) %>% filter(Time==1,stream=="Chiwawa"),aes(x=mig_year ,y=p_fit,color=LH)) + geom_point(position=position_dodge(width = .5))+geom_linerange(aes(ymin=lcl_p,ymax=ucl_p),position=position_dodge(width = .5))+facet_grid(time~LWe_J,scales="free",labeller =  labeller(LWe_J=c(`0`="NOT Detected at Lower Wen.",`1`="Detected at Lower Wen."),time=c(`2`="Lower Wenatchee",`3`="McNary")))+xlab("Smolt year")+ylab("Detection")+ylim(0,1)+ scale_color_viridis(discrete=T,end=.7)+scale_x_discrete(guide = guide_axis(check.overlap = TRUE))

#time 3 (McN_J LH x stream x year)
# dev.new()
ggplot(data= as_tibble(p.design.dat)%>% filter(Time==2,stream=="Chiwawa"),aes(x=mig_year ,y=p_fit,color=LH)) + geom_point(position=position_dodge(width = .5))+geom_linerange(aes(ymin=lcl_p,ymax=ucl_p),position=position_dodge(width = .5))+facet_grid(time~McN_J,scales="free",labeller =  labeller(McN_J=c(`0`="Bonneville (not detected @ McNary)",`1`="Bonneville (detected @ McNary)"),time=c(`4`="Bonneville")))+ylim(0,1)+xlab("Smolt year")+ylab("Detection")+ scale_color_viridis(discrete=T,end=.7)+scale_x_discrete(guide = guide_axis(check.overlap = TRUE))

#time 4-5 (stratum x year)
# dev.new()
ggplot(data= as_tibble(p.design.dat)%>% filter(Time>2),aes(x=mig_year ,y=p_fit,color=stratum)) + geom_point(position=position_dodge(width = .5))+geom_linerange(aes(ymin=lcl_p,ymax=ucl_p),position=position_dodge(width = .5))+facet_grid(~time,scales="free",labeller =  labeller(time=c(`5`="Bonneville (adult)",`6`=" McNary (adult)")))+ylim(0,1)+xlab("Return year")+ylab("Detection")+ scale_color_viridis(option="B",discrete=T,end=.7)+labs(color = "Sea years")+scale_x_discrete(guide = guide_axis(check.overlap = TRUE))
```  

\newpage

### Goodness of fit

Standardized quantile residual goodness of fit diagnostics from DHARMa

```{r GOF, echo=FALSE,eval=TRUE, message=FALSE, warning=FALSE}
# extract MLE of parameters and empiricle Bayes estimates of random effects
last_best<-mscjs_fit$mod$env$last.par.best

# summarize detections by stream x LH x year x state x occasion 
obs_dat<-mscjs_dat$dat_out %>% 
  #make states their own columns
  mutate(across(Bon_A :Tum_A,~as.numeric(.==2),.names="{col}_2"),.before="ch") %>% 
    mutate(across(Bon_A :Tum_A,~as.numeric(.==3),.names="{col}_3"),.before="ch") %>% 
    mutate(across(Bon_A :Tum_A,~as.numeric(.==1))) %>% 
  #multiply CH by frequency
  mutate(across(LWe_J :Tum_A_3,~.*freq)) %>% 
  #drop unneeded columns 
   select(!c(ch:freq ) ) %>%
  #sum detection by stream, year, and life history
  group_by(LH,stream,sea_Year_p) %>% summarise(across(LWe_J :Tum_A_3, sum)) %>% ungroup()

# make a "long" version of the summarized observations with a row for each value
obs_dat_long<- obs_dat%>% pivot_longer(LWe_J :Tum_A_3) %>%   filter(!(LH=="Unk" & name==("LWe_J")))

# Draw paramater-set samples from the posterior
sim_posterior<-rmvnorm_prec(mu=mscjs_fit$mod$env$last.par.best, 
                            prec=mscjs_fit$fit$SD$jointPrecision, 500, random_seed=1 )  


#calculate posterior predictive p value
Free_Tuk_post_p<-
Freem_Tuk_P(obs_dat_long,mscjs_fit,sim_posterior,mscjs_dat,sim_rand=0)

Free_Tuk_post_p_rand_year<-
Freem_Tuk_P(obs_dat_long,mscjs_fit,sim_posterior,mscjs_dat,sim_rand=1)


#The Bayesian p-value when the empricle Bayes estimates of the random effects were used in the data simulations was `r Free_Tuk_post_p$p` and when we sampled the random year effects from the hypderdistribution it was `r Free_Tuk_post_p_rand_year$p`. This indicates that most of the time the simulated data were were closer to the expected value based on the parameters than the observed data .

```






```{r DHARMa_GOF, echo=FALSE,eval=TRUE, message=TRUE, warning=FALSE}
# standardized residuals
dharm_sim<-make_stan_res(mscjs_fit,mscjs_dat,obs_dat_long,sim_rand=0,n_samps = 250)
dharm_sim_samp_year<-make_stan_res(mscjs_fit,mscjs_dat,obs_dat_long,sim_rand=1,n_samps = 250) #sampling random year effects from hypder distribution
```

\  
*Data simulated conditional on empirical Bayes estimates of random-year effects*  
\  


```{r DHARMa_GOF_plots1, echo=FALSE,eval=TRUE, message=TRUE, warning=FALSE,fig.height=7, fig.width=8}
plot(dharm_sim,quantreg=TRUE)
testDispersion(dharm_sim)
testOutliers(dharm_sim,type = "bootstrap")

#When data were simulated based on the fitted values for random effects, the standardized residuals were underdispersed, suggesting that we are are sacrificing some power in the data to make inference.
```

\newpage  
*Data simulated based sampling random-year effects from hypderdistribution (unconditional)*  
\  
```{r DHARMa_GOF_plots2, echo=FALSE,eval=TRUE, message=TRUE, warning=FALSE,fig.height=7, fig.width=8}
plot(dharm_sim_samp_year,quantreg=TRUE)
testDispersion(dharm_sim_samp_year)
testOutliers(dharm_sim_samp_year,type = "bootstrap")

#When random effects were simulated, the standardized residuals looked good. This suggests that this model could be used to simulate unobserved years, such as we might want to do in a population viability analysis.
```


```{r DHARMa_extra,eval=FALSE}
plotResiduals(dharm_sim, paste(obs_dat_long$stream,obs_dat_long$LH,ob))
abline(h=.5)
rm(obs_dat)
out_group<-recalculateResiduals(dharm_sim,group=paste(obs_dat_long$name,obs_dat_long$stream,obs_dat_long$LH))


#scaled residuals
sr<-out_group$scaledResiduals
names(sr)<-sort(unique(out_group$group))
sort(sr)
sr[sr>0.75]
sr[sr<0.25]

fp_resp<-out_group$fittedPredictedResponse
names(fp_resp)<-sort(unique(out_group$group))
sort(fp_resp)

exp_det_MLE %>% filter(name=="Tum_A_2") %>% group_by(stream,LH) %>% summarize(sum(value))
obs_dat_long %>% filter(name=="Tum_A_2") %>% group_by(stream,LH) %>% summarize(sum(value))

plot(out_group,quantreg=TRUE)
hist(out_group$scaledResiduals)
testOutliers(out_group)
testDispersion(out_group)
plotResiduals(out_group,quantreg=FALSE,form=1:12)
out_group

```  



```{r prog_mark_mod,eval=FALSE}

#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
# Mark model for comparison
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
dat_out<-select(mark_file_CH,sea_Year_p,LH,stream, #grouping variables
                McN_J,Bon_J) %>% #sites/occasions to include in model
  #first year with all stream data through last year where data on all three return ages is available (because it is 2020)
  filter(sea_Year_p>=2007&sea_Year_p<=2016 &!sea_Year_p%in%c(2011:2012),LH=="Unk") %>%
  #make grouping variables factors
  #mutate_at(vars(sea_Year_p:stream),~as.factor(as.character(.x)))%>% mutate(McN_J=apply(select(.,McN_J,JDD_J),1,max)) %>% select(-JDD_J) %>% 
  #create multistate capture histories
  mutate(ch=select(., c( McN_J,Bon_J)) %>%  reduce(paste0)) %>%
  #mutate(ch=select(., McN_J,Bon_J,Est_J) %>% reduce(paste0)) %>%
  mutate(ch=paste0("1",ch)) 

library(RMark)
wenatchee.processed=process.data(dat_out,model="CJS",groups = c("sea_Year_p"))
#wenatchee.processed=process.data(test_dat,model="MSCJS",strata.labels=c("A","B","C"))
wenatchee.ddl=make.design.data(wenatchee.processed)



#
# p
#
#
# States B&C dont exist for juveniles (times 2-5)

#wenatchee.ddl$p<-wenatchee.ddl$p[-wenatchee.ddl$p$Time<=2&wenatchee.ddl$p$stratum!="A",]
#wenatchee.ddl$S<-wenatchee.ddl$S[-wenatchee.ddl$S$Time<=2&wenatchee.ddl$S$stratum!="A",]



#column for migration year where onupstream state A is seaward year +1, b +2, and c +3
seaward_year_vec<-as.numeric(substr(wenatchee.ddl$p$sea_Year_p,2,5))
wenatchee.ddl$p$det_year<-factor(ifelse(wenatchee.ddl$p$Time<2,seaward_year_vec,ifelse(wenatchee.ddl$p$stratum==1,seaward_year_vec+1,ifelse(wenatchee.ddl$p$stratum==2,seaward_year_vec+2,seaward_year_vec+3))))



#wenatchee.ddl$p$fix=ifelse((wenatchee.ddl$p$stratum!="A"&wenatchee.ddl$p$Time<=4),0,NA)
# set detection at Tumwater adult at 100% based on other work
wenatchee.ddl$p$fix[wenatchee.ddl$p$time==9]=1


#
# Psi
#
# can only change state (other than death) at time 4
# rest are fixed values
wenatchee.ddl$Psi$fix=NA
# stay in current state (year) other than time 4 (ocean)
wenatchee.ddl$Psi$fix[wenatchee.ddl$Psi$stratum==
                        wenatchee.ddl$Psi$tostratum & wenatchee.ddl$Psi$time!=(4)]=1

wenatchee.ddl$Psi$fix[wenatchee.ddl$Psi$stratum!=
                        wenatchee.ddl$Psi$tostratum &wenatchee.ddl$Psi$time!=(4)]=0

wenatchee.ddl$Psi$fix[wenatchee.ddl$Psi$stratum!=1 &
                        wenatchee.ddl$Psi$time==4]=0



# 
# S
#
#Add a columna for whether first occasion, which is necessarily  different for subyearlings and yearlings
wenatchee.ddl$S$time_1<-ifelse(wenatchee.ddl$S$time==1,1,0)
#
#column for yearlings vs subs
wenatchee.ddl$S$Yrlng<-ifelse(wenatchee.ddl$S$LH=="smolt",1,0)
#
#columns for whether white river, which might be different because above lake Wenatchee
wenatchee.ddl$S$White<-ifelse(wenatchee.ddl$S$stream=="White",1,0)
#
#
#column for migration year where onupstream state A is seaward year +1, b +2, and c +3
seaward_year_vec<-as.numeric(substr(wenatchee.ddl$S$sea_Year_p,2,5))
wenatchee.ddl$S$det_year<-factor(ifelse(wenatchee.ddl$S$Time<2,seaward_year_vec,ifelse(wenatchee.ddl$S$stratum=="A",seaward_year_vec+1,ifelse(wenatchee.ddl$S$stratum=="B",seaward_year_vec+2,seaward_year_vec+3))))


wenatchee.ddl$S$upstream_time<-ifelse(wenatchee.ddl$S$Time>2,1,0)


# fixing S to 1 in strata where fish cant be
wenatchee.ddl$S$fix<-NA
wenatchee.ddl$S$fix[wenatchee.ddl$S$stratum!=1 &
                      wenatchee.ddl$S$Time<=3]=1 #using numeric "Time" which starts at 0 hence 3 is 4





# fit model
p.timexstratum.tag=list(formula=~-1+time)
Psi.sxtime=list(formula=~-1+tostratum)
S.stratumxtime=list(formula=~-1+time+time_1:Yrlng)


test<-RMark::mark(wenatchee.processed,wenatchee.ddl,
                  model.parameters=list(Phi=list(formula=~-1+time),p= list(formula=~-1+time)),run=TRUE)

real_test<-get.real(test,par="Phi")
phi<-as.numeric(lapply(real_test,function(x)x$pim[1,1]))
mean(phi)


real_test$`Group:sea_Year_p2007`$pim

real_test
test$results$beta

sd_rep$value

#compare parameters
sd_rep$par.fixed - test$results$beta[,1]
#compare standard errors
sqrt(diag(sd_rep$cov.fixed)) - test$results$beta[,2]


```




